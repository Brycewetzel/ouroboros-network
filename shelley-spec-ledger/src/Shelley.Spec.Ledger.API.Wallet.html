<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Shelley.Spec.Ledger.API.Wallet</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getNonMyopicMemberRewards"><span class="hs-identifier">getNonMyopicMemberRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getUTxO"><span class="hs-identifier">getUTxO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getFilteredUTxO"><span class="hs-identifier">getFilteredUTxO</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getLeaderSchedule"><span class="hs-identifier">getLeaderSchedule</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getTotalStake"><span class="hs-identifier">getTotalStake</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#poolsByTotalStakeFraction"><span class="hs-identifier">poolsByTotalStakeFraction</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src"><span class="hs-identifier">Cardano.Crypto.VRF</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VRF</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Crypto.html"><span class="hs-identifier">Cardano.Ledger.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Crypto.html#VRF"><span class="hs-identifier">VRF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Era.html"><span class="hs-identifier">Cardano.Ledger.Era</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier">Crypto</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Era.html#Era"><span class="hs-identifier">Era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.html"><span class="hs-identifier">Cardano.Ledger.Shelley</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyBased"><span class="hs-identifier">ShelleyBased</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier">Cardano.Slotting.EpochInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier">epochInfoRange</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier">Cardano.Slotting.Slot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier">SlotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fold</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">runIdentity</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ratio</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(%)</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Protocol.html"><span class="hs-identifier">Shelley.Spec.Ledger.API.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.API.Protocol.html#ChainDepState"><span class="hs-identifier">ChainDepState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Address.html"><span class="hs-identifier">Shelley.Spec.Ledger.Address</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Address.html#Addr"><span class="hs-identifier">Addr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html"><span class="hs-identifier">Shelley.Spec.Ledger.BaseTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Globals"><span class="hs-identifier">Globals</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Seed"><span class="hs-identifier">Seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BlockChain.html"><span class="hs-identifier">Shelley.Spec.Ledger.BlockChain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.BlockChain.html#checkLeaderValue"><span class="hs-identifier">checkLeaderValue</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BlockChain.html#mkSeed"><span class="hs-identifier">mkSeed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BlockChain.html#seedL"><span class="hs-identifier">seedL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html"><span class="hs-identifier">Shelley.Spec.Ledger.Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.CompactAddr.html"><span class="hs-identifier">Shelley.Spec.Ledger.CompactAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.CompactAddr.html#compactAddr"><span class="hs-identifier">compactAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Credential.html"><span class="hs-identifier">Shelley.Spec.Ledger.Credential</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Credential.html#Credential"><span class="hs-identifier">Credential</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html"><span class="hs-identifier">Shelley.Spec.Ledger.Delegation.Certificates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#IndividualPoolStake"><span class="hs-identifier">IndividualPoolStake</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#PoolDistr"><span class="hs-identifier">PoolDistr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.EpochBoundary.html"><span class="hs-identifier">Shelley.Spec.Ledger.EpochBoundary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EB</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html"><span class="hs-identifier">Shelley.Spec.Ledger.Keys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#KeyHash"><span class="hs-identifier">KeyHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#KeyRole"><span class="hs-identifier">KeyRole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#SignKeyVRF"><span class="hs-identifier">SignKeyVRF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html"><span class="hs-identifier">Shelley.Spec.Ledger.LedgerState</span></a></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#DPState"><span class="hs-identifier">DPState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#EpochState"><span class="hs-identifier">EpochState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#LedgerState"><span class="hs-identifier">LedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier">NewEpochState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#UTxOState"><span class="hs-identifier">UTxOState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#circulation"><span class="hs-identifier">circulation</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#stakeDistr"><span class="hs-identifier">stakeDistr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.OverlaySchedule.html"><span class="hs-identifier">Shelley.Spec.Ledger.OverlaySchedule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.OverlaySchedule.html#isOverlaySlot"><span class="hs-identifier">isOverlaySlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.PParams.html"><span class="hs-identifier">Shelley.Spec.Ledger.PParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.PParams.html#PParams"><span class="hs-identifier">PParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.PParams.html#PParams%27"><span class="hs-identifier">PParams'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html"><span class="hs-identifier">Shelley.Spec.Ledger.Rewards</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#NonMyopic"><span class="hs-identifier">NonMyopic</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#StakeShare"><span class="hs-identifier">StakeShare</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#getTopRankedPools"><span class="hs-identifier">getTopRankedPools</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#nonMyopicMemberRew"><span class="hs-identifier">nonMyopicMemberRew</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#percentile%27"><span class="hs-identifier">percentile'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.STS.NewEpoch.html"><span class="hs-identifier">Shelley.Spec.Ledger.STS.NewEpoch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.STS.NewEpoch.html#calculatePoolDistr"><span class="hs-identifier">calculatePoolDistr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.STS.Tickn.html"><span class="hs-identifier">Shelley.Spec.Ledger.STS.Tickn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.STS.Tickn.html#TicknState"><span class="hs-identifier">TicknState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.TxBody.html"><span class="hs-identifier">Shelley.Spec.Ledger.TxBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.TxBody.html#PoolParams"><span class="hs-identifier">PoolParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.TxBody.html#TxOut"><span class="hs-identifier">TxOut</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.UTxO.html"><span class="hs-identifier">Shelley.Spec.Ledger.UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.UTxO.html#UTxO"><span class="hs-identifier">UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- | Get pool sizes, but in terms of total stake</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- The stake distribution uses active stake (so that the leader schedule is not</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- affected by undelegated stake), but the wallet wants to display pool</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- saturation for rewards purposes. For that, it needs the fraction of total</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- stake.</span><span>
</span><span id="line-72"></span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- This is not based on any snapshot, but uses the current ledger state.</span><span>
</span><span id="line-74"></span><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#poolsByTotalStakeFraction"><span class="hs-identifier hs-type">poolsByTotalStakeFraction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680030528"><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyBased"><span class="hs-identifier hs-type">ShelleyBased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Globals"><span class="hs-identifier hs-type">Globals</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#PoolDistr"><span class="hs-identifier hs-type">PoolDistr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span id="poolsByTotalStakeFraction"><span class="annot"><span class="annottext">poolsByTotalStakeFraction :: Globals -&gt; NewEpochState era -&gt; PoolDistr (Crypto era)
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#poolsByTotalStakeFraction"><span class="hs-identifier hs-var hs-var">poolsByTotalStakeFraction</span></a></span></span><span> </span><span id="local-6989586621680030527"><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030527"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621680030526"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030526"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
-&gt; PoolDistr (Crypto era)
forall crypto.
Map (KeyHash 'StakePool crypto) (IndividualPoolStake crypto)
-&gt; PoolDistr crypto
</span><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#PoolDistr"><span class="hs-identifier hs-var">PoolDistr</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030524"><span class="hs-identifier hs-var">poolsByTotalStake</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-83"></span><span>    </span><span id="local-6989586621680030523"><span class="annot"><span class="annottext">snap :: SnapShot era
</span><a href="#local-6989586621680030523"><span class="hs-identifier hs-var">snap</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-type">EB.SnapShot</span></a></span><span> </span><span id="local-6989586621680030521"><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030521"><span class="hs-identifier hs-var">stake</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking era) (KeyHash 'StakePool (Crypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; SnapShot era
forall era. ShelleyBased era =&gt; NewEpochState era -&gt; SnapShot era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#currentSnapshot"><span class="hs-identifier hs-var">currentSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030526"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621680030518"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030518"><span class="hs-identifier hs-var">totalStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Globals -&gt; NewEpochState era -&gt; Coin
forall era. Globals -&gt; NewEpochState era -&gt; Coin
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getTotalStake"><span class="hs-identifier hs-var">getTotalStake</span></a></span><span> </span><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030527"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030526"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621680030517"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030517"><span class="hs-identifier hs-var">activeStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking era) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span> </span><span class="annot"><span class="annottext">(Map (Credential 'Staking era) Coin -&gt; Coin)
-&gt; (Stake era -&gt; Map (Credential 'Staking era) Coin)
-&gt; Stake era
-&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stake era -&gt; Map (Credential 'Staking era) Coin
forall era. Stake era -&gt; Map (Credential 'Staking era) Coin
</span><a href="Shelley.Spec.Ledger.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">EB.unStake</span></a></span><span> </span><span class="annot"><span class="annottext">(Stake era -&gt; Coin) -&gt; Stake era -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030521"><span class="hs-identifier hs-var">stake</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621680030514"><span class="annot"><span class="annottext">stakeRatio :: Ratio Integer
</span><a href="#local-6989586621680030514"><span class="hs-identifier hs-var hs-var">stakeRatio</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030517"><span class="hs-identifier hs-var">activeStake</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Ratio Integer
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030518"><span class="hs-identifier hs-var">totalStake</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#PoolDistr"><span class="hs-identifier hs-type">PoolDistr</span></a></span><span> </span><span id="local-6989586621680030513"><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030513"><span class="hs-identifier hs-var">poolsByActiveStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShot era -&gt; PoolDistr (Crypto era)
forall era. SnapShot era -&gt; PoolDistr (Crypto era)
</span><a href="Shelley.Spec.Ledger.STS.NewEpoch.html#calculatePoolDistr"><span class="hs-identifier hs-var">calculatePoolDistr</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShot era
</span><a href="#local-6989586621680030523"><span class="hs-identifier hs-var">snap</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621680030524"><span class="annot"><span class="annottext">poolsByTotalStake :: Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030524"><span class="hs-identifier hs-var hs-var">poolsByTotalStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IndividualPoolStake (Crypto era)
 -&gt; IndividualPoolStake (Crypto era))
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (IndividualPoolStake (Crypto era))
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (IndividualPoolStake (Crypto era))
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.map</span></span><span> </span><span class="annot"><span class="annottext">IndividualPoolStake (Crypto era)
-&gt; IndividualPoolStake (Crypto era)
</span><a href="#local-6989586621680030511"><span class="hs-identifier hs-var">toTotalStakeFrac</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030513"><span class="hs-identifier hs-var">poolsByActiveStake</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="#local-6989586621680030511"><span class="hs-identifier hs-type">toTotalStakeFrac</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#IndividualPoolStake"><span class="hs-identifier hs-type">IndividualPoolStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#IndividualPoolStake"><span class="hs-identifier hs-type">IndividualPoolStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030528"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621680030511"><span class="annot"><span class="annottext">toTotalStakeFrac :: IndividualPoolStake (Crypto era)
-&gt; IndividualPoolStake (Crypto era)
</span><a href="#local-6989586621680030511"><span class="hs-identifier hs-var hs-var">toTotalStakeFrac</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#IndividualPoolStake"><span class="hs-identifier hs-type">IndividualPoolStake</span></a></span><span> </span><span id="local-6989586621680030509"><span class="annot"><span class="annottext">Ratio Integer
</span><a href="#local-6989586621680030509"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621680030508"><span class="annot"><span class="annottext">Hash (Crypto era) (VerKeyVRF (Crypto era))
</span><a href="#local-6989586621680030508"><span class="hs-identifier hs-var">vrf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">Ratio Integer
-&gt; Hash (Crypto era) (VerKeyVRF (Crypto era))
-&gt; IndividualPoolStake (Crypto era)
forall crypto.
Ratio Integer
-&gt; Hash crypto (VerKeyVRF crypto) -&gt; IndividualPoolStake crypto
</span><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#IndividualPoolStake"><span class="hs-identifier hs-var">IndividualPoolStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ratio Integer
</span><a href="#local-6989586621680030509"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Integer -&gt; Ratio Integer -&gt; Ratio Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Ratio Integer
</span><a href="#local-6989586621680030514"><span class="hs-identifier hs-var">stakeRatio</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Hash (Crypto era) (VerKeyVRF (Crypto era))
</span><a href="#local-6989586621680030508"><span class="hs-identifier hs-var">vrf</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Calculate the current total stake.</span><span>
</span><span id="line-94"></span><span id="local-6989586621680030673"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getTotalStake"><span class="hs-identifier hs-type">getTotalStake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Globals"><span class="hs-identifier hs-type">Globals</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030673"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-95"></span><span id="getTotalStake"><span class="annot"><span class="annottext">getTotalStake :: Globals -&gt; NewEpochState era -&gt; Coin
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getTotalStake"><span class="hs-identifier hs-var hs-var">getTotalStake</span></a></span></span><span> </span><span id="local-6989586621680030506"><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030506"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621680030505"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030505"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680030504"><span class="annot"><span class="annottext">supply :: Coin
</span><a href="#local-6989586621680030504"><span class="hs-identifier hs-var hs-var">supply</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Coin) -&gt; (Word64 -&gt; Integer) -&gt; Word64 -&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Coin) -&gt; Word64 -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Globals -&gt; Word64
</span><a href="Shelley.Spec.Ledger.BaseTypes.html#maxLovelaceSupply"><span class="hs-identifier hs-var hs-var">maxLovelaceSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030506"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span id="local-6989586621680030502"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621680030502"><span class="hs-identifier hs-var hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
forall era. NewEpochState era -&gt; EpochState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesEs"><span class="hs-identifier hs-var hs-var">nesEs</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030505"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-98"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; Coin -&gt; Coin
forall era. EpochState era -&gt; Coin -&gt; Coin
</span><a href="Shelley.Spec.Ledger.LedgerState.html#circulation"><span class="hs-identifier hs-var">circulation</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030502"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030504"><span class="hs-identifier hs-var">supply</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Calculate the Non-Myopic Pool Member Rewards for a set of credentials.</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- For each given credential, this function returns a map from each stake</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- pool (identified by the key hash of the pool operator) to the</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- non-myopic pool member reward for that stake pool.</span><span>
</span><span id="line-104"></span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- This is not based on any snapshot, but uses the current ledger state.</span><span>
</span><span id="line-106"></span><span id="local-6989586621680030500"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getNonMyopicMemberRewards"><span class="hs-identifier hs-type">getNonMyopicMemberRewards</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyBased"><span class="hs-identifier hs-type">ShelleyBased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030500"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Globals"><span class="hs-identifier hs-type">Globals</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030500"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Credential.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#Staking"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030500"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Credential.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#Staking"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030500"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#KeyHash"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#StakePool"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030500"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-112"></span><span id="getNonMyopicMemberRewards"><span class="annot"><span class="annottext">getNonMyopicMemberRewards :: Globals
-&gt; NewEpochState era
-&gt; Set (Either Coin (Credential 'Staking era))
-&gt; Map
     (Either Coin (Credential 'Staking era))
     (Map (KeyHash 'StakePool (Crypto era)) Coin)
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getNonMyopicMemberRewards"><span class="hs-identifier hs-var hs-var">getNonMyopicMemberRewards</span></a></span></span><span> </span><span id="local-6989586621680030499"><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030499"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621680030498"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030498"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621680030497"><span class="annot"><span class="annottext">Set (Either Coin (Credential 'Staking era))
</span><a href="#local-6989586621680030497"><span class="hs-identifier hs-var">creds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="annottext">[(Either Coin (Credential 'Staking era),
  Map (KeyHash 'StakePool (Crypto era)) Coin)]
-&gt; Map
     (Either Coin (Credential 'Staking era))
     (Map (KeyHash 'StakePool (Crypto era)) Coin)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Either Coin (Credential 'Staking era),
   Map (KeyHash 'StakePool (Crypto era)) Coin)]
 -&gt; Map
      (Either Coin (Credential 'Staking era))
      (Map (KeyHash 'StakePool (Crypto era)) Coin))
-&gt; [(Either Coin (Credential 'Staking era),
     Map (KeyHash 'StakePool (Crypto era)) Coin)]
-&gt; Map
     (Either Coin (Credential 'Staking era))
     (Map (KeyHash 'StakePool (Crypto era)) Coin)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><span class="annottext">(Either Coin (Credential 'Staking era)
 -&gt; (Either Coin (Credential 'Staking era),
     Map (KeyHash 'StakePool (Crypto era)) Coin))
-&gt; [Either Coin (Credential 'Staking era)]
-&gt; [(Either Coin (Credential 'Staking era),
     Map (KeyHash 'StakePool (Crypto era)) Coin)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680030495"><span class="annot"><span class="annottext">Either Coin (Credential 'Staking era)
</span><a href="#local-6989586621680030495"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either Coin (Credential 'Staking era)
</span><a href="#local-6989586621680030495"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((PerformanceEstimate, PoolParams era, StakeShare) -&gt; Coin)
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (PerformanceEstimate, PoolParams era, StakeShare)
-&gt; Map (KeyHash 'StakePool (Crypto era)) Coin
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakeShare
-&gt; (PerformanceEstimate, PoolParams era, StakeShare) -&gt; Coin
</span><a href="#local-6989586621680030494"><span class="hs-identifier hs-var">mkNMMRewards</span></a></span><span> </span><span class="annot"><span class="annottext">(StakeShare
 -&gt; (PerformanceEstimate, PoolParams era, StakeShare) -&gt; Coin)
-&gt; StakeShare
-&gt; (PerformanceEstimate, PoolParams era, StakeShare)
-&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either Coin (Credential 'Staking era) -&gt; StakeShare
</span><a href="#local-6989586621680030493"><span class="hs-identifier hs-var">memShare</span></a></span><span> </span><span class="annot"><span class="annottext">Either Coin (Credential 'Staking era)
</span><a href="#local-6989586621680030495"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (PerformanceEstimate, PoolParams era, StakeShare)
</span><a href="#local-6989586621680030492"><span class="hs-identifier hs-var">poolData</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (Either Coin (Credential 'Staking era))
-&gt; [Either Coin (Credential 'Staking era)]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set (Either Coin (Credential 'Staking era))
</span><a href="#local-6989586621680030497"><span class="hs-identifier hs-var">creds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621680030490"><span class="annot"><span class="annottext">maxSupply :: Coin
</span><a href="#local-6989586621680030490"><span class="hs-identifier hs-var hs-var">maxSupply</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Coin) -&gt; (Word64 -&gt; Integer) -&gt; Word64 -&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Coin) -&gt; Word64 -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Globals -&gt; Word64
</span><a href="Shelley.Spec.Ledger.BaseTypes.html#maxLovelaceSupply"><span class="hs-identifier hs-var hs-var">maxLovelaceSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030499"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621680030489"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030489"><span class="hs-identifier hs-var">totalStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; Coin -&gt; Coin
forall era. EpochState era -&gt; Coin -&gt; Coin
</span><a href="Shelley.Spec.Ledger.LedgerState.html#circulation"><span class="hs-identifier hs-var">circulation</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030488"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030490"><span class="hs-identifier hs-var">maxSupply</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621680030487"><span class="annot"><span class="annottext">toShare :: Coin -&gt; StakeShare
</span><a href="#local-6989586621680030487"><span class="hs-identifier hs-var hs-var">toShare</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621680030486"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030486"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Integer -&gt; StakeShare
</span><a href="Shelley.Spec.Ledger.Rewards.html#StakeShare"><span class="hs-identifier hs-var">StakeShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030486"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Ratio Integer
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030489"><span class="hs-identifier hs-var">totalStake</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621680030493"><span class="annot"><span class="annottext">memShare :: Either Coin (Credential 'Staking era) -&gt; StakeShare
</span><a href="#local-6989586621680030493"><span class="hs-identifier hs-var hs-var">memShare</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680030484"><span class="annot"><span class="annottext">Credential 'Staking era
</span><a href="#local-6989586621680030484"><span class="hs-identifier hs-var">cred</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; StakeShare
</span><a href="#local-6989586621680030487"><span class="hs-identifier hs-var">toShare</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; StakeShare) -&gt; Coin -&gt; StakeShare
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Coin
-&gt; Credential 'Staking era
-&gt; Map (Credential 'Staking era) Coin
-&gt; Coin
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking era
</span><a href="#local-6989586621680030484"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stake era -&gt; Map (Credential 'Staking era) Coin
forall era. Stake era -&gt; Map (Credential 'Staking era) Coin
</span><a href="Shelley.Spec.Ledger.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">EB.unStake</span></a></span><span> </span><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030482"><span class="hs-identifier hs-var">stake</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><a href="#local-6989586621680030493"><span class="hs-identifier hs-var">memShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680030481"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030481"><span class="hs-identifier hs-var">coin</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; StakeShare
</span><a href="#local-6989586621680030487"><span class="hs-identifier hs-var">toShare</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030481"><span class="hs-identifier hs-var">coin</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621680030488"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621680030488"><span class="hs-identifier hs-var hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
forall era. NewEpochState era -&gt; EpochState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesEs"><span class="hs-identifier hs-var hs-var">nesEs</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030498"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621680030480"><span class="annot"><span class="annottext">pp :: PParams era
</span><a href="#local-6989586621680030480"><span class="hs-identifier hs-var hs-var">pp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; PParams era
forall era. EpochState era -&gt; PParams era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esPp"><span class="hs-identifier hs-var hs-var">esPp</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030488"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.Rewards.html#NonMyopic"><span class="hs-identifier hs-type">NonMyopic</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">likelihoodsNM :: forall era.
NonMyopic era -&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="Shelley.Spec.Ledger.Rewards.html#likelihoodsNM"><span class="hs-identifier hs-var">likelihoodsNM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680030476"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="#local-6989586621680030476"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">rewardPotNM :: forall era. NonMyopic era -&gt; Coin
</span><a href="Shelley.Spec.Ledger.Rewards.html#rewardPotNM"><span class="hs-identifier hs-var">rewardPotNM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680030474"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030474"><span class="hs-identifier hs-var">rPot</span></a></span></span><span>
</span><span id="line-128"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; NonMyopic era
forall era. EpochState era -&gt; NonMyopic era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esNonMyopic"><span class="hs-identifier hs-var hs-var">esNonMyopic</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030488"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-type">EB.SnapShot</span></a></span><span> </span><span id="local-6989586621680030482"><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030482"><span class="hs-identifier hs-var">stake</span></a></span></span><span> </span><span id="local-6989586621680030472"><span class="annot"><span class="annottext">Map (Credential 'Staking era) (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621680030472"><span class="hs-identifier hs-var">delegs</span></a></span></span><span> </span><span id="local-6989586621680030471"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
</span><a href="#local-6989586621680030471"><span class="hs-identifier hs-var">poolParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; SnapShot era
forall era. ShelleyBased era =&gt; NewEpochState era -&gt; SnapShot era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#currentSnapshot"><span class="hs-identifier hs-var">currentSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030498"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621680030492"><span class="annot"><span class="annottext">poolData :: Map
  (KeyHash 'StakePool (Crypto era))
  (PerformanceEstimate, PoolParams era, StakeShare)
</span><a href="#local-6989586621680030492"><span class="hs-identifier hs-var hs-var">poolData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">(KeyHash 'StakePool (Crypto era)
 -&gt; PoolParams era
 -&gt; (PerformanceEstimate, PoolParams era, StakeShare))
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (PerformanceEstimate, PoolParams era, StakeShare)
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapWithKey</span></span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680030469"><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030469"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680030468"><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030468"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Likelihood -&gt; PerformanceEstimate
</span><a href="Shelley.Spec.Ledger.Rewards.html#percentile%27"><span class="hs-identifier hs-var">percentile'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era) -&gt; Likelihood
</span><a href="#local-6989586621680030467"><span class="hs-identifier hs-var">histLookup</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030469"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>              </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030468"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>              </span><span class="annot"><span class="annottext">Coin -&gt; StakeShare
</span><a href="#local-6989586621680030487"><span class="hs-identifier hs-var">toShare</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; StakeShare)
-&gt; (Stake era -&gt; Coin) -&gt; Stake era -&gt; StakeShare
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking era) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span>
</span><span id="line-136"></span><span>                </span><span class="annot"><span class="annottext">(Map (Credential 'Staking era) Coin -&gt; Coin)
-&gt; (Stake era -&gt; Map (Credential 'Staking era) Coin)
-&gt; Stake era
-&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stake era -&gt; Map (Credential 'Staking era) Coin
forall era. Stake era -&gt; Map (Credential 'Staking era) Coin
</span><a href="Shelley.Spec.Ledger.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">EB.unStake</span></a></span><span>
</span><span id="line-137"></span><span>                </span><span class="annot"><span class="annottext">(Stake era -&gt; StakeShare) -&gt; Stake era -&gt; StakeShare
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
-&gt; Map (Credential 'Staking era) (KeyHash 'StakePool (Crypto era))
-&gt; Stake era
-&gt; Stake era
forall era.
KeyHash 'StakePool (Crypto era)
-&gt; Map (Credential 'Staking era) (KeyHash 'StakePool (Crypto era))
-&gt; Stake era
-&gt; Stake era
</span><a href="Shelley.Spec.Ledger.EpochBoundary.html#poolStake"><span class="hs-identifier hs-var">EB.poolStake</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030469"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking era) (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621680030472"><span class="hs-identifier hs-var">delegs</span></a></span><span> </span><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030482"><span class="hs-identifier hs-var">stake</span></a></span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
</span><a href="#local-6989586621680030471"><span class="hs-identifier hs-var">poolParams</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span id="local-6989586621680030467"><span class="annot"><span class="annottext">histLookup :: KeyHash 'StakePool (Crypto era) -&gt; Likelihood
</span><a href="#local-6989586621680030467"><span class="hs-identifier hs-var hs-var">histLookup</span></a></span></span><span> </span><span id="local-6989586621680030465"><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030465"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Likelihood -&gt; Maybe Likelihood -&gt; Likelihood
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Likelihood
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
-&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood
-&gt; Maybe Likelihood
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030465"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="#local-6989586621680030476"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span id="local-6989586621680030463"><span class="annot"><span class="annottext">topPools :: Set (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621680030463"><span class="hs-identifier hs-var hs-var">topPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
-&gt; Coin
-&gt; PParams era
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
-&gt; Map (KeyHash 'StakePool (Crypto era)) PerformanceEstimate
-&gt; Set (KeyHash 'StakePool (Crypto era))
forall era.
Coin
-&gt; Coin
-&gt; PParams era
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
-&gt; Map (KeyHash 'StakePool (Crypto era)) PerformanceEstimate
-&gt; Set (KeyHash 'StakePool (Crypto era))
</span><a href="Shelley.Spec.Ledger.Rewards.html#getTopRankedPools"><span class="hs-identifier hs-var">getTopRankedPools</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030474"><span class="hs-identifier hs-var">rPot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="Shelley.Spec.Ledger.Coin.html#Coin"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680030489"><span class="hs-identifier hs-var">totalStake</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621680030480"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolParams era)
</span><a href="#local-6989586621680030471"><span class="hs-identifier hs-var">poolParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Likelihood -&gt; PerformanceEstimate)
-&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood
-&gt; Map (KeyHash 'StakePool (Crypto era)) PerformanceEstimate
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Likelihood -&gt; PerformanceEstimate
</span><a href="Shelley.Spec.Ledger.Rewards.html#percentile%27"><span class="hs-identifier hs-var">percentile'</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="#local-6989586621680030476"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621680030494"><span class="annot"><span class="annottext">mkNMMRewards :: StakeShare
-&gt; (PerformanceEstimate, PoolParams era, StakeShare) -&gt; Coin
</span><a href="#local-6989586621680030494"><span class="hs-identifier hs-var hs-var">mkNMMRewards</span></a></span></span><span> </span><span id="local-6989586621680030462"><span class="annot"><span class="annottext">StakeShare
</span><a href="#local-6989586621680030462"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680030461"><span class="annot"><span class="annottext">PerformanceEstimate
</span><a href="#local-6989586621680030461"><span class="hs-identifier hs-var">hitRateEst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680030460"><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030460"><span class="hs-identifier hs-var">poolp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680030459"><span class="annot"><span class="annottext">StakeShare
</span><a href="#local-6989586621680030459"><span class="hs-identifier hs-var">sigma</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PoolParams era -&gt; Bool
</span><a href="#local-6989586621680030458"><span class="hs-identifier hs-var">checkPledge</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030460"><span class="hs-identifier hs-var">poolp</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PParams era
-&gt; Coin
-&gt; PoolParams era
-&gt; StakeShare
-&gt; StakeShare
-&gt; StakeShare
-&gt; Set (KeyHash 'StakePool (Crypto era))
-&gt; PerformanceEstimate
-&gt; Coin
forall era.
PParams era
-&gt; Coin
-&gt; PoolParams era
-&gt; StakeShare
-&gt; StakeShare
-&gt; StakeShare
-&gt; Set (KeyHash 'StakePool (Crypto era))
-&gt; PerformanceEstimate
-&gt; Coin
</span><a href="Shelley.Spec.Ledger.Rewards.html#nonMyopicMemberRew"><span class="hs-identifier hs-var">nonMyopicMemberRew</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621680030480"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030474"><span class="hs-identifier hs-var">rPot</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030460"><span class="hs-identifier hs-var">poolp</span></a></span><span> </span><span class="annot"><span class="annottext">StakeShare
</span><a href="#local-6989586621680030457"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">StakeShare
</span><a href="#local-6989586621680030459"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">StakeShare
</span><a href="#local-6989586621680030462"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621680030463"><span class="hs-identifier hs-var">topPools</span></a></span><span> </span><span class="annot"><span class="annottext">PerformanceEstimate
</span><a href="#local-6989586621680030461"><span class="hs-identifier hs-var">hitRateEst</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Coin
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-148"></span><span>        </span><span id="local-6989586621680030457"><span class="annot"><span class="annottext">s :: StakeShare
</span><a href="#local-6989586621680030457"><span class="hs-identifier hs-var hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; StakeShare
</span><a href="#local-6989586621680030487"><span class="hs-identifier hs-var">toShare</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; StakeShare)
-&gt; (PoolParams era -&gt; Coin) -&gt; PoolParams era -&gt; StakeShare
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PoolParams era -&gt; Coin
forall era. PoolParams era -&gt; Coin
</span><a href="Shelley.Spec.Ledger.TxBody.html#_poolPledge"><span class="hs-identifier hs-var hs-var">_poolPledge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030460"><span class="hs-identifier hs-var">poolp</span></a></span><span>
</span><span id="line-149"></span><span>        </span><span id="local-6989586621680030458"><span class="annot"><span class="annottext">checkPledge :: PoolParams era -&gt; Bool
</span><a href="#local-6989586621680030458"><span class="hs-identifier hs-var hs-var">checkPledge</span></a></span></span><span> </span><span id="local-6989586621680030455"><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030455"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-150"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680030454"><span class="annot"><span class="annottext">ostake :: Coin
</span><a href="#local-6989586621680030454"><span class="hs-identifier hs-var hs-var">ostake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-151"></span><span>                </span><span class="annot"><span class="annottext">(Coin -&gt; KeyHash 'Staking (Crypto era) -&gt; Coin)
-&gt; Coin -&gt; Set (KeyHash 'Staking (Crypto era)) -&gt; Coin
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Set b -&gt; a
</span><span class="hs-identifier hs-var">Set.foldl'</span></span><span>
</span><span id="line-152"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680030452"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030452"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621680030451"><span class="annot"><span class="annottext">KeyHash 'Staking (Crypto era)
</span><a href="#local-6989586621680030451"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-153"></span><span>                      </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030452"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-154"></span><span>                        </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin -&gt; Coin
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Coin
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Coin -&gt; Coin) -&gt; Maybe Coin -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-155"></span><span>                               </span><span class="annot"><span class="annottext">Credential 'Staking era
-&gt; Map (Credential 'Staking era) Coin -&gt; Maybe Coin
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'Staking (Crypto era) -&gt; Credential 'Staking era
forall (kr :: KeyRole) era.
KeyHash kr (Crypto era) -&gt; Credential kr era
</span><a href="Shelley.Spec.Ledger.Credential.html#KeyHashObj"><span class="hs-identifier hs-var">KeyHashObj</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'Staking (Crypto era)
</span><a href="#local-6989586621680030451"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stake era -&gt; Map (Credential 'Staking era) Coin
forall era. Stake era -&gt; Map (Credential 'Staking era) Coin
</span><a href="Shelley.Spec.Ledger.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">EB.unStake</span></a></span><span> </span><span class="annot"><span class="annottext">Stake era
</span><a href="#local-6989586621680030482"><span class="hs-identifier hs-var">stake</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>                  </span><span class="annot"><span class="annottext">Coin
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-159"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolParams era -&gt; Set (KeyHash 'Staking (Crypto era))
forall era. PoolParams era -&gt; Set (KeyHash 'Staking (Crypto era))
</span><a href="Shelley.Spec.Ledger.TxBody.html#_poolOwners"><span class="hs-identifier hs-var hs-var">_poolOwners</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030455"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PoolParams era -&gt; Coin
forall era. PoolParams era -&gt; Coin
</span><a href="Shelley.Spec.Ledger.TxBody.html#_poolPledge"><span class="hs-identifier hs-var hs-var">_poolPledge</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams era
</span><a href="#local-6989586621680030460"><span class="hs-identifier hs-var">poolp</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621680030454"><span class="hs-identifier hs-var">ostake</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Create a current snapshot of the ledger state.</span><span>
</span><span id="line-163"></span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- When ranking pools, and reporting their saturation level, in the wallet, we</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- do not want to use one of the regular snapshots, but rather the most recent</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- ledger state.</span><span>
</span><span id="line-167"></span><span id="local-6989586621680030676"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#currentSnapshot"><span class="hs-identifier hs-type">currentSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyBased"><span class="hs-identifier hs-type">ShelleyBased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030676"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030676"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Shelley.Spec.Ledger.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-type">EB.SnapShot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030676"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-168"></span><span id="currentSnapshot"><span class="annot"><span class="annottext">currentSnapshot :: NewEpochState era -&gt; SnapShot era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#currentSnapshot"><span class="hs-identifier hs-var hs-var">currentSnapshot</span></a></span></span><span> </span><span id="local-6989586621680030447"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030447"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="annottext">UTxO era -&gt; DState era -&gt; PState era -&gt; SnapShot era
forall era.
ShelleyBased era =&gt;
UTxO era -&gt; DState era -&gt; PState era -&gt; SnapShot era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#stakeDistr"><span class="hs-identifier hs-var">stakeDistr</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621680030446"><span class="hs-identifier hs-var">utxo</span></a></span><span> </span><span class="annot"><span class="annottext">DState era
</span><a href="#local-6989586621680030445"><span class="hs-identifier hs-var">dstate</span></a></span><span> </span><span class="annot"><span class="annottext">PState era
</span><a href="#local-6989586621680030444"><span class="hs-identifier hs-var">pstate</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621680030443"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621680030443"><span class="hs-identifier hs-var hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
forall era. NewEpochState era -&gt; EpochState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesEs"><span class="hs-identifier hs-var hs-var">nesEs</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030447"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621680030446"><span class="annot"><span class="annottext">utxo :: UTxO era
</span><a href="#local-6989586621680030446"><span class="hs-identifier hs-var hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; UTxO era
forall era. UTxOState era -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_utxo"><span class="hs-identifier hs-var hs-var">_utxo</span></a></span><span> </span><span class="annot"><span class="annottext">(UTxOState era -&gt; UTxO era)
-&gt; (EpochState era -&gt; UTxOState era) -&gt; EpochState era -&gt; UTxO era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
forall era. LedgerState era -&gt; UTxOState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_utxoState"><span class="hs-identifier hs-var hs-var">_utxoState</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState era -&gt; UTxOState era)
-&gt; (EpochState era -&gt; LedgerState era)
-&gt; EpochState era
-&gt; UTxOState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
forall era. EpochState era -&gt; LedgerState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochState era -&gt; UTxO era) -&gt; EpochState era -&gt; UTxO era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030443"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621680030445"><span class="annot"><span class="annottext">dstate :: DState era
</span><a href="#local-6989586621680030445"><span class="hs-identifier hs-var hs-var">dstate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPState era -&gt; DState era
forall era. DPState era -&gt; DState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_dstate"><span class="hs-identifier hs-var hs-var">_dstate</span></a></span><span> </span><span class="annot"><span class="annottext">(DPState era -&gt; DState era)
-&gt; (EpochState era -&gt; DPState era) -&gt; EpochState era -&gt; DState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState era
forall era. LedgerState era -&gt; DPState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_delegationState"><span class="hs-identifier hs-var hs-var">_delegationState</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState era -&gt; DPState era)
-&gt; (EpochState era -&gt; LedgerState era)
-&gt; EpochState era
-&gt; DPState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
forall era. EpochState era -&gt; LedgerState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochState era -&gt; DState era) -&gt; EpochState era -&gt; DState era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030443"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621680030444"><span class="annot"><span class="annottext">pstate :: PState era
</span><a href="#local-6989586621680030444"><span class="hs-identifier hs-var hs-var">pstate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPState era -&gt; PState era
forall era. DPState era -&gt; PState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_pstate"><span class="hs-identifier hs-var hs-var">_pstate</span></a></span><span> </span><span class="annot"><span class="annottext">(DPState era -&gt; PState era)
-&gt; (EpochState era -&gt; DPState era) -&gt; EpochState era -&gt; PState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState era
forall era. LedgerState era -&gt; DPState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_delegationState"><span class="hs-identifier hs-var hs-var">_delegationState</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState era -&gt; DPState era)
-&gt; (EpochState era -&gt; LedgerState era)
-&gt; EpochState era
-&gt; DPState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
forall era. EpochState era -&gt; LedgerState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochState era -&gt; PState era) -&gt; EpochState era -&gt; PState era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621680030443"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-comment">-- | Get the full UTxO.</span><span>
</span><span id="line-177"></span><span id="local-6989586621680030590"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getUTxO"><span class="hs-identifier hs-type">getUTxO</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030590"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030590"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-180"></span><span id="getUTxO"><span class="annot"><span class="annottext">getUTxO :: NewEpochState era -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getUTxO"><span class="hs-identifier hs-var hs-var">getUTxO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; UTxO era
forall era. UTxOState era -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_utxo"><span class="hs-identifier hs-var hs-var">_utxo</span></a></span><span> </span><span class="annot"><span class="annottext">(UTxOState era -&gt; UTxO era)
-&gt; (NewEpochState era -&gt; UTxOState era)
-&gt; NewEpochState era
-&gt; UTxO era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
forall era. LedgerState era -&gt; UTxOState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#_utxoState"><span class="hs-identifier hs-var hs-var">_utxoState</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState era -&gt; UTxOState era)
-&gt; (NewEpochState era -&gt; LedgerState era)
-&gt; NewEpochState era
-&gt; UTxOState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
forall era. EpochState era -&gt; LedgerState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochState era -&gt; LedgerState era)
-&gt; (NewEpochState era -&gt; EpochState era)
-&gt; NewEpochState era
-&gt; LedgerState era
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
forall era. NewEpochState era -&gt; EpochState era
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesEs"><span class="hs-identifier hs-var hs-var">nesEs</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Get the UTxO filtered by address.</span><span>
</span><span id="line-183"></span><span id="local-6989586621680030436"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getFilteredUTxO"><span class="hs-identifier hs-type">getFilteredUTxO</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030436"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.Address.html#Addr"><span class="hs-identifier hs-type">Addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030436"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030436"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-187"></span><span id="getFilteredUTxO"><span class="annot"><span class="annottext">getFilteredUTxO :: NewEpochState era -&gt; Set (Addr era) -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getFilteredUTxO"><span class="hs-identifier hs-var hs-var">getFilteredUTxO</span></a></span></span><span> </span><span id="local-6989586621680030435"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030435"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621680030434"><span class="annot"><span class="annottext">Set (Addr era)
</span><a href="#local-6989586621680030434"><span class="hs-identifier hs-var">addrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">Map (TxIn era) (TxOut era) -&gt; UTxO era
forall era. Map (TxIn era) (TxOut era) -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.UTxO.html#UTxO"><span class="hs-identifier hs-var">UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (TxIn era) (TxOut era) -&gt; UTxO era)
-&gt; Map (TxIn era) (TxOut era) -&gt; UTxO era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TxOut era -&gt; Bool)
-&gt; Map (TxIn era) (TxOut era) -&gt; Map (TxIn era) (TxOut era)
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Shelley.Spec.Ledger.TxBody.html#TxOutCompact"><span class="hs-identifier hs-type">TxOutCompact</span></a></span><span> </span><span id="local-6989586621680030430"><span class="annot"><span class="annottext">CompactAddr era
</span><a href="#local-6989586621680030430"><span class="hs-identifier hs-var">addrSBS</span></a></span></span><span> </span><span class="annot"><span class="annottext">CompactForm (Value era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CompactAddr era
</span><a href="#local-6989586621680030430"><span class="hs-identifier hs-var">addrSBS</span></a></span><span> </span><span class="annot"><span class="annottext">CompactAddr era -&gt; Set (CompactAddr era) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`Set.member`</span></span><span> </span><span class="annot"><span class="annottext">Set (CompactAddr era)
</span><a href="#local-6989586621680030428"><span class="hs-identifier hs-var">addrSBSs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (TxIn era) (TxOut era)
</span><a href="#local-6989586621680030427"><span class="hs-identifier hs-var">fullUTxO</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span id="local-6989586621680030427"><span class="annot"><span class="annottext">Map (TxIn era) (TxOut era)
</span><a href="#local-6989586621680030427"><span class="hs-identifier hs-var">fullUTxO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; UTxO era
forall era. NewEpochState era -&gt; UTxO era
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getUTxO"><span class="hs-identifier hs-var">getUTxO</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030435"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">-- Instead of decompacting each address in the huge UTxO, compact each</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-comment">-- address in the small set of address.</span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621680030428"><span class="annot"><span class="annottext">addrSBSs :: Set (CompactAddr era)
</span><a href="#local-6989586621680030428"><span class="hs-identifier hs-var hs-var">addrSBSs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Addr era -&gt; CompactAddr era)
-&gt; Set (Addr era) -&gt; Set (CompactAddr era)
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Addr era -&gt; CompactAddr era
forall era. Addr era -&gt; CompactAddr era
</span><a href="Shelley.Spec.Ledger.CompactAddr.html#compactAddr"><span class="hs-identifier hs-var">compactAddr</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Addr era)
</span><a href="#local-6989586621680030434"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Get the (private) leader schedule for this epoch.</span><span>
</span><span id="line-196"></span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span class="hs-comment">--   Given a private VRF key, returns the set of slots in which this node is</span><span>
</span><span id="line-198"></span><span class="hs-comment">--   eligible to lead.</span><span>
</span><span id="line-199"></span><span id="local-6989586621680030425"><span class="annot"><a href="Shelley.Spec.Ledger.API.Wallet.html#getLeaderSchedule"><span class="hs-identifier hs-type">getLeaderSchedule</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src"><span class="hs-identifier hs-type">VRF.Signable</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Crypto.html#VRF"><span class="hs-identifier hs-type">VRF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Seed"><span class="hs-identifier hs-type">Seed</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.BaseTypes.html#Globals"><span class="hs-identifier hs-type">Globals</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.API.Protocol.html#ChainDepState"><span class="hs-identifier hs-type">ChainDepState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#KeyHash"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#StakePool"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.Keys.html#SignKeyVRF"><span class="hs-identifier hs-type">SignKeyVRF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Era.html#Crypto"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><a href="Shelley.Spec.Ledger.PParams.html#PParams"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680030425"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier hs-type">SlotNo</span></a></span></span><span>
</span><span id="line-212"></span><span id="getLeaderSchedule"><span class="annot"><span class="annottext">getLeaderSchedule :: Globals
-&gt; NewEpochState era
-&gt; ChainDepState (Crypto era)
-&gt; KeyHash 'StakePool (Crypto era)
-&gt; SignKeyVRF (Crypto era)
-&gt; PParams era
-&gt; Set SlotNo
</span><a href="Shelley.Spec.Ledger.API.Wallet.html#getLeaderSchedule"><span class="hs-identifier hs-var hs-var">getLeaderSchedule</span></a></span></span><span> </span><span id="local-6989586621680030424"><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030424"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621680030423"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030423"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621680030422"><span class="annot"><span class="annottext">ChainDepState (Crypto era)
</span><a href="#local-6989586621680030422"><span class="hs-identifier hs-var">cds</span></a></span></span><span> </span><span id="local-6989586621680030421"><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030421"><span class="hs-identifier hs-var">poolHash</span></a></span></span><span> </span><span id="local-6989586621680030420"><span class="annot"><span class="annottext">SignKeyVRF (Crypto era)
</span><a href="#local-6989586621680030420"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621680030419"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621680030419"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool) -&gt; Set SlotNo -&gt; Set SlotNo
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.filter</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Bool
</span><a href="#local-6989586621680030417"><span class="hs-identifier hs-var">isLeader</span></a></span><span> </span><span class="annot"><span class="annottext">Set SlotNo
</span><a href="#local-6989586621680030416"><span class="hs-identifier hs-var">epochSlots</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621680030417"><span class="annot"><span class="annottext">isLeader :: SlotNo -&gt; Bool
</span><a href="#local-6989586621680030417"><span class="hs-identifier hs-var hs-var">isLeader</span></a></span></span><span> </span><span id="local-6989586621680030415"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030415"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680030414"><span class="annot"><span class="annottext">y :: CertifiedVRF (VRF (Crypto era)) Seed
</span><a href="#local-6989586621680030414"><span class="hs-identifier hs-var hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContextVRF (VRF (Crypto era))
-&gt; Seed
-&gt; SignKeyVRF (Crypto era)
-&gt; CertifiedVRF (VRF (Crypto era)) Seed
forall v a.
(VRFAlgorithm v, Signable v a) =&gt;
ContextVRF v -&gt; a -&gt; SignKeyVRF v -&gt; CertifiedVRF v a
</span><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src"><span class="hs-identifier hs-var">VRF.evalCertified</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nonce -&gt; SlotNo -&gt; Nonce -&gt; Seed
</span><a href="Shelley.Spec.Ledger.BlockChain.html#mkSeed"><span class="hs-identifier hs-var">mkSeed</span></a></span><span> </span><span class="annot"><span class="annottext">Nonce
</span><a href="Shelley.Spec.Ledger.BlockChain.html#seedL"><span class="hs-identifier hs-var">seedL</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030415"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Nonce
</span><a href="#local-6989586621680030412"><span class="hs-identifier hs-var">epochNonce</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SignKeyVRF (Crypto era)
</span><a href="#local-6989586621680030420"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-216"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; UnitInterval -&gt; SlotNo -&gt; Bool
</span><a href="Shelley.Spec.Ledger.OverlaySchedule.html#isOverlaySlot"><span class="hs-identifier hs-var">isOverlaySlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030410"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; HKD Identity UnitInterval
forall (f :: * -&gt; *) era. PParams' f era -&gt; HKD f UnitInterval
</span><a href="Shelley.Spec.Ledger.PParams.html#_d"><span class="hs-identifier hs-var hs-var">_d</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621680030419"><span class="hs-identifier hs-var">pp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030415"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OutputVRF (VRF (Crypto era))
-&gt; Ratio Integer -&gt; ActiveSlotCoeff -&gt; Bool
forall v.
VRFAlgorithm v =&gt;
OutputVRF v -&gt; Ratio Integer -&gt; ActiveSlotCoeff -&gt; Bool
</span><a href="Shelley.Spec.Ledger.BlockChain.html#checkLeaderValue"><span class="hs-identifier hs-var">checkLeaderValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertifiedVRF (VRF (Crypto era)) Seed
-&gt; OutputVRF (VRF (Crypto era))
forall v a. CertifiedVRF v a -&gt; OutputVRF v
</span><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src"><span class="hs-identifier hs-var hs-var">VRF.certifiedOutput</span></a></span><span> </span><span class="annot"><span class="annottext">CertifiedVRF (VRF (Crypto era)) Seed
</span><a href="#local-6989586621680030414"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ratio Integer
</span><a href="#local-6989586621680030406"><span class="hs-identifier hs-var">stake</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621680030405"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621680030406"><span class="annot"><span class="annottext">stake :: Ratio Integer
</span><a href="#local-6989586621680030406"><span class="hs-identifier hs-var hs-var">stake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Integer
-&gt; (IndividualPoolStake (Crypto era) -&gt; Ratio Integer)
-&gt; Maybe (IndividualPoolStake (Crypto era))
-&gt; Ratio Integer
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Ratio Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">IndividualPoolStake (Crypto era) -&gt; Ratio Integer
forall crypto. IndividualPoolStake crypto -&gt; Ratio Integer
</span><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#individualPoolStake"><span class="hs-identifier hs-var hs-var">individualPoolStake</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (IndividualPoolStake (Crypto era)) -&gt; Ratio Integer)
-&gt; Maybe (IndividualPoolStake (Crypto era)) -&gt; Ratio Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (IndividualPoolStake (Crypto era))
-&gt; Maybe (IndividualPoolStake (Crypto era))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
</span><a href="#local-6989586621680030421"><span class="hs-identifier hs-var">poolHash</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030402"><span class="hs-identifier hs-var">poolDistr</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621680030402"><span class="annot"><span class="annottext">poolDistr :: Map
  (KeyHash 'StakePool (Crypto era))
  (IndividualPoolStake (Crypto era))
</span><a href="#local-6989586621680030402"><span class="hs-identifier hs-var hs-var">poolDistr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolDistr (Crypto era)
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (IndividualPoolStake (Crypto era))
forall crypto.
PoolDistr crypto
-&gt; Map (KeyHash 'StakePool crypto) (IndividualPoolStake crypto)
</span><a href="Shelley.Spec.Ledger.Delegation.Certificates.html#unPoolDistr"><span class="hs-identifier hs-var hs-var">unPoolDistr</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolDistr (Crypto era)
 -&gt; Map
      (KeyHash 'StakePool (Crypto era))
      (IndividualPoolStake (Crypto era)))
-&gt; PoolDistr (Crypto era)
-&gt; Map
     (KeyHash 'StakePool (Crypto era))
     (IndividualPoolStake (Crypto era))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; PoolDistr (Crypto era)
forall era. NewEpochState era -&gt; PoolDistr (Crypto era)
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesPd"><span class="hs-identifier hs-var hs-var">nesPd</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030423"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><a href="Shelley.Spec.Ledger.STS.Tickn.html#TicknState"><span class="hs-identifier hs-type">TicknState</span></a></span><span> </span><span id="local-6989586621680030412"><span class="annot"><span class="annottext">Nonce
</span><a href="#local-6989586621680030412"><span class="hs-identifier hs-var">epochNonce</span></a></span></span><span> </span><span class="annot"><span class="annottext">Nonce
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDepState (Crypto era) -&gt; TicknState
forall crypto. ChainDepState crypto -&gt; TicknState
</span><a href="Shelley.Spec.Ledger.API.Protocol.html#csTickn"><span class="hs-identifier hs-var hs-var">csTickn</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState (Crypto era)
</span><a href="#local-6989586621680030422"><span class="hs-identifier hs-var">cds</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621680030397"><span class="annot"><span class="annottext">currentEpoch :: EpochNo
</span><a href="#local-6989586621680030397"><span class="hs-identifier hs-var hs-var">currentEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochNo
forall era. NewEpochState era -&gt; EpochNo
</span><a href="Shelley.Spec.Ledger.LedgerState.html#nesEL"><span class="hs-identifier hs-var hs-var">nesEL</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621680030423"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621680030395"><span class="annot"><span class="annottext">ei :: EpochInfo Identity
</span><a href="#local-6989586621680030395"><span class="hs-identifier hs-var hs-var">ei</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Globals -&gt; EpochInfo Identity
</span><a href="Shelley.Spec.Ledger.BaseTypes.html#epochInfo"><span class="hs-identifier hs-var hs-var">epochInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030424"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621680030405"><span class="annot"><span class="annottext">f :: ActiveSlotCoeff
</span><a href="#local-6989586621680030405"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Globals -&gt; ActiveSlotCoeff
</span><a href="Shelley.Spec.Ledger.BaseTypes.html#activeSlotCoeff"><span class="hs-identifier hs-var hs-var">activeSlotCoeff</span></a></span><span> </span><span class="annot"><span class="annottext">Globals
</span><a href="#local-6989586621680030424"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621680030416"><span class="annot"><span class="annottext">epochSlots :: Set SlotNo
</span><a href="#local-6989586621680030416"><span class="hs-identifier hs-var hs-var">epochSlots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SlotNo] -&gt; Set SlotNo
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030410"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030391"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680030410"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030410"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680030391"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680030391"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (SlotNo, SlotNo) -&gt; (SlotNo, SlotNo)
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (SlotNo, SlotNo) -&gt; (SlotNo, SlotNo))
-&gt; Identity (SlotNo, SlotNo) -&gt; (SlotNo, SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EpochInfo Identity -&gt; EpochNo -&gt; Identity (SlotNo, SlotNo)
forall (m :: * -&gt; *).
Monad m =&gt;
EpochInfo m -&gt; EpochNo -&gt; m (SlotNo, SlotNo)
</span><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier hs-var">epochInfoRange</span></a></span><span> </span><span class="annot"><span class="annottext">EpochInfo Identity
</span><a href="#local-6989586621680030395"><span class="hs-identifier hs-var">ei</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621680030397"><span class="hs-identifier hs-var">currentEpoch</span></a></span><span>
</span><span id="line-226"></span></pre></body></html>