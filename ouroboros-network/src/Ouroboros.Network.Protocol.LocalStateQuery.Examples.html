<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Protocol.LocalStateQuery.Examples</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalStateQuery.Client</span></a></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalStateQuery.Server</span></a></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalStateQuery.Type</span></a></span><span>
</span><span id="line-8"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier">AcquireFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Example client</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">-- | An example 'LocalStateQueryClient', which, for each point in the given</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- list, acquires the state for that point, and if that succeeds, returns the</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- result for the corresponding query. When the state could not be acquired,</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- the 'AcquireFailure' is returned instead of the query results.</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Examples.html#localStateQueryClient"><span class="hs-identifier hs-type">localStateQueryClient</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679214014"><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679214013"><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span></span><span> </span><span id="local-6989586621679214012"><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span></span><span> </span><span id="local-6989586621679214011"><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span></span><span> </span><span id="local-6989586621679214010"><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-22"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#LocalStateQueryClient"><span class="hs-identifier hs-type">LocalStateQueryClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-25"></span><span>                           </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-26"></span><span id="localStateQueryClient"><span class="annot"><span class="annottext">localStateQueryClient :: [(point, query result)]
-&gt; LocalStateQueryClient
     block point query m [(point, Either AcquireFailure result)]
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Examples.html#localStateQueryClient"><span class="hs-identifier hs-var hs-var">localStateQueryClient</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ClientStIdle
     block point query m [(point, Either AcquireFailure result)])
-&gt; LocalStateQueryClient
     block point query m [(point, Either AcquireFailure result)]
forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
m (ClientStIdle block point query m a)
-&gt; LocalStateQueryClient block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#LocalStateQueryClient"><span class="hs-identifier hs-var">LocalStateQueryClient</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ClientStIdle
      block point query m [(point, Either AcquireFailure result)])
 -&gt; LocalStateQueryClient
      block point query m [(point, Either AcquireFailure result)])
-&gt; ([(point, query result)]
    -&gt; m (ClientStIdle
            block point query m [(point, Either AcquireFailure result)]))
-&gt; [(point, query result)]
-&gt; LocalStateQueryClient
     block point query m [(point, Either AcquireFailure result)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ClientStIdle
  block point query m [(point, Either AcquireFailure result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClientStIdle
   block point query m [(point, Either AcquireFailure result)]
 -&gt; m (ClientStIdle
         block point query m [(point, Either AcquireFailure result)]))
-&gt; ([(point, query result)]
    -&gt; ClientStIdle
         block point query m [(point, Either AcquireFailure result)])
-&gt; [(point, query result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; [(point, query result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214007"><span class="hs-identifier hs-var">goIdle</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="#local-6989586621679214007"><span class="hs-identifier hs-type">goIdle</span></a></span><span>
</span><span id="line-29"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Accumulator</span><span>
</span><span id="line-30"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Remainder</span><span>
</span><span id="line-31"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStIdle"><span class="hs-identifier hs-type">ClientStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-32"></span><span>                      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-33"></span><span>    </span><span id="local-6989586621679214007"><span class="annot"><span class="annottext">goIdle :: [(point, Either AcquireFailure result)]
-&gt; [(point, query result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214007"><span class="hs-identifier hs-var hs-var">goIdle</span></a></span></span><span> </span><span id="local-6989586621679214006"><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214006"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall a block point (query :: * -&gt; *) (m :: * -&gt; *).
a -&gt; ClientStIdle block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgDone"><span class="hs-identifier hs-var">SendMsgDone</span></a></span><span> </span><span class="annot"><span class="annottext">([(point, Either AcquireFailure result)]
 -&gt; ClientStIdle
      block point query m [(point, Either AcquireFailure result)])
-&gt; [(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; [(point, Either AcquireFailure result)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214006"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="#local-6989586621679214007"><span class="hs-identifier hs-var">goIdle</span></a></span><span> </span><span id="local-6989586621679214003"><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214003"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679214002"><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679214002"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679214001"><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679214001"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679214000"><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679214000"><span class="hs-identifier hs-var">ptqs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">point
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall point block (query :: * -&gt; *) (m :: * -&gt; *) a.
point
-&gt; ClientStAcquiring block point query m a
-&gt; ClientStIdle block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgAcquire"><span class="hs-identifier hs-var">SendMsgAcquire</span></a></span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679214002"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientStAcquiring
   block point query m [(point, Either AcquireFailure result)]
 -&gt; ClientStIdle
      block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; point
-&gt; query result
-&gt; [(point, query result)]
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213998"><span class="hs-identifier hs-var">goAcquiring</span></a></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214003"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679214002"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679214001"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679214000"><span class="hs-identifier hs-var">ptqs'</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="#local-6989586621679213998"><span class="hs-identifier hs-type">goAcquiring</span></a></span><span>
</span><span id="line-37"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Accumulator</span><span>
</span><span id="line-38"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span>
</span><span id="line-39"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-40"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Remainder</span><span>
</span><span id="line-41"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStAcquiring"><span class="hs-identifier hs-type">ClientStAcquiring</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-42"></span><span>                           </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621679213998"><span class="annot"><span class="annottext">goAcquiring :: [(point, Either AcquireFailure result)]
-&gt; point
-&gt; query result
-&gt; [(point, query result)]
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213998"><span class="hs-identifier hs-var hs-var">goAcquiring</span></a></span></span><span> </span><span id="local-6989586621679213997"><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213997"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679213996"><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213996"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621679213995"><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213995"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679213994"><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679213994"><span class="hs-identifier hs-var">ptqss'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientStAcquiring :: forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
ClientStAcquired block point query m a
-&gt; (AcquireFailure -&gt; m (ClientStIdle block point query m a))
-&gt; ClientStAcquiring block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStAcquiring"><span class="hs-identifier hs-type">ClientStAcquiring</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-44"></span><span>        </span><span class="annot"><span class="annottext">recvMsgAcquired :: ClientStAcquired
  block point query m [(point, Either AcquireFailure result)]
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#recvMsgAcquired"><span class="hs-identifier hs-var">recvMsgAcquired</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">query result
-&gt; (result
    -&gt; ClientStAcquired
         block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall a.
query result
-&gt; (result -&gt; ClientStAcquired block point query m a)
-&gt; ClientStAcquired block point query m a
</span><a href="#local-6989586621679213991"><span class="hs-identifier hs-var">goQuery</span></a></span><span> </span><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213995"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">((result
  -&gt; ClientStAcquired
       block point query m [(point, Either AcquireFailure result)])
 -&gt; ClientStAcquired
      block point query m [(point, Either AcquireFailure result)])
-&gt; (result
    -&gt; ClientStAcquired
         block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679213990"><span class="annot"><span class="annottext">result
</span><a href="#local-6989586621679213990"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; [(point, query result)]
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213989"><span class="hs-identifier hs-var">goAcquired</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213996"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">result -&gt; Either AcquireFailure result
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">result
</span><a href="#local-6989586621679213990"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(point, Either AcquireFailure result)
-&gt; [(point, Either AcquireFailure result)]
-&gt; [(point, Either AcquireFailure result)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213997"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679213994"><span class="hs-identifier hs-var">ptqss'</span></a></span><span>
</span><span id="line-45"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgFailure :: AcquireFailure
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#recvMsgFailure"><span class="hs-identifier hs-var">recvMsgFailure</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679213987"><span class="annot"><span class="annottext">AcquireFailure
</span><a href="#local-6989586621679213987"><span class="hs-identifier hs-var">failure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientStIdle
  block point query m [(point, Either AcquireFailure result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClientStIdle
   block point query m [(point, Either AcquireFailure result)]
 -&gt; m (ClientStIdle
         block point query m [(point, Either AcquireFailure result)]))
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; [(point, query result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679214007"><span class="hs-identifier hs-var">goIdle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213996"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AcquireFailure -&gt; Either AcquireFailure result
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">AcquireFailure
</span><a href="#local-6989586621679213987"><span class="hs-identifier hs-var">failure</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(point, Either AcquireFailure result)
-&gt; [(point, Either AcquireFailure result)]
-&gt; [(point, Either AcquireFailure result)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213997"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679213994"><span class="hs-identifier hs-var">ptqss'</span></a></span><span>
</span><span id="line-46"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="#local-6989586621679213989"><span class="hs-identifier hs-type">goAcquired</span></a></span><span>
</span><span id="line-49"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-50"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ Remainder</span><span>
</span><span id="line-51"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStAcquired"><span class="hs-identifier hs-type">ClientStAcquired</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-52"></span><span>                          </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-53"></span><span>    </span><span id="local-6989586621679213989"><span class="annot"><span class="annottext">goAcquired :: [(point, Either AcquireFailure result)]
-&gt; [(point, query result)]
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213989"><span class="hs-identifier hs-var hs-var">goAcquired</span></a></span></span><span> </span><span id="local-6989586621679213986"><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213986"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ClientStIdle
     block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall (m :: * -&gt; *) block point (query :: * -&gt; *) a.
m (ClientStIdle block point query m a)
-&gt; ClientStAcquired block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgRelease"><span class="hs-identifier hs-var">SendMsgRelease</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ClientStIdle
      block point query m [(point, Either AcquireFailure result)])
 -&gt; ClientStAcquired
      block point query m [(point, Either AcquireFailure result)])
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientStIdle
  block point query m [(point, Either AcquireFailure result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClientStIdle
   block point query m [(point, Either AcquireFailure result)]
 -&gt; m (ClientStIdle
         block point query m [(point, Either AcquireFailure result)]))
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
-&gt; m (ClientStIdle
        block point query m [(point, Either AcquireFailure result)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall a block point (query :: * -&gt; *) (m :: * -&gt; *).
a -&gt; ClientStIdle block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgDone"><span class="hs-identifier hs-var">SendMsgDone</span></a></span><span> </span><span class="annot"><span class="annottext">([(point, Either AcquireFailure result)]
 -&gt; ClientStIdle
      block point query m [(point, Either AcquireFailure result)])
-&gt; [(point, Either AcquireFailure result)]
-&gt; ClientStIdle
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; [(point, Either AcquireFailure result)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213986"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="#local-6989586621679213989"><span class="hs-identifier hs-var">goAcquired</span></a></span><span> </span><span id="local-6989586621679213984"><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213984"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679213983"><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213983"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679213982"><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213982"><span class="hs-identifier hs-var">qs</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679213981"><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679213981"><span class="hs-identifier hs-var">ptqss'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">point
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall point block (query :: * -&gt; *) (m :: * -&gt; *) a.
point
-&gt; ClientStAcquiring block point query m a
-&gt; ClientStAcquired block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgReAcquire"><span class="hs-identifier hs-var">SendMsgReAcquire</span></a></span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213983"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientStAcquiring
   block point query m [(point, Either AcquireFailure result)]
 -&gt; ClientStAcquired
      block point query m [(point, Either AcquireFailure result)])
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
-&gt; ClientStAcquired
     block point query m [(point, Either AcquireFailure result)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-55"></span><span>      </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
-&gt; point
-&gt; query result
-&gt; [(point, query result)]
-&gt; ClientStAcquiring
     block point query m [(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213998"><span class="hs-identifier hs-var">goAcquiring</span></a></span><span> </span><span class="annot"><span class="annottext">[(point, Either AcquireFailure result)]
</span><a href="#local-6989586621679213984"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213983"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213982"><span class="hs-identifier hs-var">qs</span></a></span><span> </span><span class="annot"><span class="annottext">[(point, query result)]
</span><a href="#local-6989586621679213981"><span class="hs-identifier hs-var">ptqss'</span></a></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="#local-6989586621679213991"><span class="hs-identifier hs-type">goQuery</span></a></span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679214086"><span class="annot"><a href="#local-6989586621679214086"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-59"></span><span>         </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679214011"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStAcquired"><span class="hs-identifier hs-type">ClientStAcquired</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214086"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>         </span><span class="hs-comment">-- ^ Continuation</span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStAcquired"><span class="hs-identifier hs-type">ClientStAcquired</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214014"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214013"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214012"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214010"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214086"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span id="local-6989586621679213991"><span class="annot"><span class="annottext">goQuery :: query result
-&gt; (result -&gt; ClientStAcquired block point query m a)
-&gt; ClientStAcquired block point query m a
</span><a href="#local-6989586621679213991"><span class="hs-identifier hs-var hs-var">goQuery</span></a></span></span><span> </span><span id="local-6989586621679213979"><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213979"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679213978"><span class="annot"><span class="annottext">result -&gt; ClientStAcquired block point query m a
</span><a href="#local-6989586621679213978"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">query result
-&gt; ClientStQuerying block point query m a result
-&gt; ClientStAcquired block point query m a
forall (query :: * -&gt; *) result block point (m :: * -&gt; *) a.
query result
-&gt; ClientStQuerying block point query m a result
-&gt; ClientStAcquired block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#SendMsgQuery"><span class="hs-identifier hs-var">SendMsgQuery</span></a></span><span> </span><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213979"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientStQuerying block point query m a result
 -&gt; ClientStAcquired block point query m a)
-&gt; ClientStQuerying block point query m a result
-&gt; ClientStAcquired block point query m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(result -&gt; m (ClientStAcquired block point query m a))
-&gt; ClientStQuerying block point query m a result
forall block point (query :: * -&gt; *) (m :: * -&gt; *) a result.
(result -&gt; m (ClientStAcquired block point query m a))
-&gt; ClientStQuerying block point query m a result
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Client.html#ClientStQuerying"><span class="hs-identifier hs-var">ClientStQuerying</span></a></span><span> </span><span class="annot"><span class="annottext">((result -&gt; m (ClientStAcquired block point query m a))
 -&gt; ClientStQuerying block point query m a result)
-&gt; (result -&gt; m (ClientStAcquired block point query m a))
-&gt; ClientStQuerying block point query m a result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679213975"><span class="annot"><span class="annottext">result
</span><a href="#local-6989586621679213975"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientStAcquired block point query m a
-&gt; m (ClientStAcquired block point query m a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClientStAcquired block point query m a
 -&gt; m (ClientStAcquired block point query m a))
-&gt; ClientStAcquired block point query m a
-&gt; m (ClientStAcquired block point query m a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">result -&gt; ClientStAcquired block point query m a
</span><a href="#local-6989586621679213978"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">result
</span><a href="#local-6989586621679213975"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- Example server</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">-- | An example 'LocalStateQueryServer'. The first function is called to</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- acquire a @state@, after which the second will be used to query the state.</span><span>
</span><span id="line-71"></span><span class="hs-comment">--</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Examples.html#localStateQueryServer"><span class="hs-identifier hs-type">localStateQueryServer</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679213973"><span class="annot"><a href="#local-6989586621679213973"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679213972"><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span></span><span> </span><span id="local-6989586621679213971"><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span></span><span> </span><span id="local-6989586621679213970"><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679213969"><span class="annot"><a href="#local-6989586621679213969"><span class="hs-identifier hs-type">state</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Type.html#AcquireFailure"><span class="hs-identifier hs-type">AcquireFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213969"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679214056"><span class="annot"><a href="#local-6989586621679214056"><span class="hs-identifier hs-type">result</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679213969"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679214056"><span class="hs-identifier hs-type">result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679214056"><span class="hs-identifier hs-type">result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#LocalStateQueryServer"><span class="hs-identifier hs-type">LocalStateQueryServer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213973"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span id="localStateQueryServer"><span class="annot"><span class="annottext">localStateQueryServer :: (point -&gt; Either AcquireFailure state)
-&gt; (forall result. state -&gt; query result -&gt; result)
-&gt; LocalStateQueryServer block point query m ()
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Examples.html#localStateQueryServer"><span class="hs-identifier hs-var hs-var">localStateQueryServer</span></a></span></span><span> </span><span id="local-6989586621679213968"><span class="annot"><span class="annottext">point -&gt; Either AcquireFailure state
</span><a href="#local-6989586621679213968"><span class="hs-identifier hs-var">acquire</span></a></span></span><span> </span><span id="local-6989586621679213967"><span class="annot"><span class="annottext">forall result. state -&gt; query result -&gt; result
</span><a href="#local-6989586621679213967"><span class="hs-identifier hs-var">answer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="annottext">m (ServerStIdle block point query m ())
-&gt; LocalStateQueryServer block point query m ()
forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
m (ServerStIdle block point query m a)
-&gt; LocalStateQueryServer block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#LocalStateQueryServer"><span class="hs-identifier hs-var">LocalStateQueryServer</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle block point query m ())
 -&gt; LocalStateQueryServer block point query m ())
-&gt; m (ServerStIdle block point query m ())
-&gt; LocalStateQueryServer block point query m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerStIdle block point query m ()
-&gt; m (ServerStIdle block point query m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ServerStIdle block point query m ()
</span><a href="#local-6989586621679213965"><span class="hs-identifier hs-var">goIdle</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><a href="#local-6989586621679213965"><span class="hs-identifier hs-type">goIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213973"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621679213965"><span class="annot"><span class="annottext">goIdle :: ServerStIdle block point query m ()
</span><a href="#local-6989586621679213965"><span class="hs-identifier hs-var hs-var">goIdle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStIdle :: forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
(point -&gt; m (ServerStAcquiring block point query m a))
-&gt; m a -&gt; ServerStIdle block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">recvMsgAcquire :: point -&gt; m (ServerStAcquiring block point query m ())
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#recvMsgAcquire"><span class="hs-identifier hs-var">recvMsgAcquire</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">point -&gt; m (ServerStAcquiring block point query m ())
</span><a href="#local-6989586621679213962"><span class="hs-identifier hs-var">goAcquiring</span></a></span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgDone :: m ()
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#recvMsgDone"><span class="hs-identifier hs-var">recvMsgDone</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="#local-6989586621679213962"><span class="hs-identifier hs-type">goAcquiring</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#ServerStAcquiring"><span class="hs-identifier hs-type">ServerStAcquiring</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213973"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621679213962"><span class="annot"><span class="annottext">goAcquiring :: point -&gt; m (ServerStAcquiring block point query m ())
</span><a href="#local-6989586621679213962"><span class="hs-identifier hs-var hs-var">goAcquiring</span></a></span></span><span> </span><span id="local-6989586621679213960"><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213960"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStAcquiring block point query m ()
-&gt; m (ServerStAcquiring block point query m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ServerStAcquiring block point query m ()
 -&gt; m (ServerStAcquiring block point query m ()))
-&gt; ServerStAcquiring block point query m ()
-&gt; m (ServerStAcquiring block point query m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">point -&gt; Either AcquireFailure state
</span><a href="#local-6989586621679213968"><span class="hs-identifier hs-var">acquire</span></a></span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621679213960"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-88"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679213959"><span class="annot"><span class="annottext">AcquireFailure
</span><a href="#local-6989586621679213959"><span class="hs-identifier hs-var">failure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AcquireFailure
-&gt; ServerStIdle block point query m ()
-&gt; ServerStAcquiring block point query m ()
forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
AcquireFailure
-&gt; ServerStIdle block point query m a
-&gt; ServerStAcquiring block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#SendMsgFailure"><span class="hs-identifier hs-var">SendMsgFailure</span></a></span><span> </span><span class="annot"><span class="annottext">AcquireFailure
</span><a href="#local-6989586621679213959"><span class="hs-identifier hs-var">failure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle block point query m ()
</span><a href="#local-6989586621679213965"><span class="hs-identifier hs-var">goIdle</span></a></span><span>
</span><span id="line-89"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679213957"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679213957"><span class="hs-identifier hs-var">state</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerStAcquired block point query m ()
-&gt; ServerStAcquiring block point query m ()
forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
ServerStAcquired block point query m a
-&gt; ServerStAcquiring block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#SendMsgAcquired"><span class="hs-identifier hs-var">SendMsgAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStAcquired block point query m ()
 -&gt; ServerStAcquiring block point query m ())
-&gt; ServerStAcquired block point query m ()
-&gt; ServerStAcquiring block point query m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">state -&gt; ServerStAcquired block point query m ()
</span><a href="#local-6989586621679213955"><span class="hs-identifier hs-var">goAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679213957"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><a href="#local-6989586621679213955"><span class="hs-identifier hs-type">goAcquired</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679213969"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#ServerStAcquired"><span class="hs-identifier hs-type">ServerStAcquired</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213973"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213972"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213971"><span class="hs-identifier hs-type">query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213970"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679213955"><span class="annot"><span class="annottext">goAcquired :: state -&gt; ServerStAcquired block point query m ()
</span><a href="#local-6989586621679213955"><span class="hs-identifier hs-var hs-var">goAcquired</span></a></span></span><span> </span><span id="local-6989586621679213954"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679213954"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStAcquired :: forall block point (query :: * -&gt; *) (m :: * -&gt; *) a.
(forall result.
 query result -&gt; m (ServerStQuerying block point query m a result))
-&gt; (point -&gt; m (ServerStAcquiring block point query m a))
-&gt; m (ServerStIdle block point query m a)
-&gt; ServerStAcquired block point query m a
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#ServerStAcquired"><span class="hs-identifier hs-type">ServerStAcquired</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">recvMsgQuery :: forall result.
query result -&gt; m (ServerStQuerying block point query m () result)
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#recvMsgQuery"><span class="hs-identifier hs-var">recvMsgQuery</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679213951"><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213951"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>          </span><span class="annot"><span class="annottext">ServerStQuerying block point query m () result
-&gt; m (ServerStQuerying block point query m () result)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ServerStQuerying block point query m () result
 -&gt; m (ServerStQuerying block point query m () result))
-&gt; ServerStQuerying block point query m () result
-&gt; m (ServerStQuerying block point query m () result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">result
-&gt; ServerStAcquired block point query m ()
-&gt; ServerStQuerying block point query m () result
forall result block point (query :: * -&gt; *) (m :: * -&gt; *) a.
result
-&gt; ServerStAcquired block point query m a
-&gt; ServerStQuerying block point query m a result
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#SendMsgResult"><span class="hs-identifier hs-var">SendMsgResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state -&gt; query result -&gt; result
forall result. state -&gt; query result -&gt; result
</span><a href="#local-6989586621679213967"><span class="hs-identifier hs-var">answer</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679213954"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">query result
</span><a href="#local-6989586621679213951"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerStAcquired block point query m ()
 -&gt; ServerStQuerying block point query m () result)
-&gt; ServerStAcquired block point query m ()
-&gt; ServerStQuerying block point query m () result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">state -&gt; ServerStAcquired block point query m ()
</span><a href="#local-6989586621679213955"><span class="hs-identifier hs-var">goAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679213954"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgReAcquire :: point -&gt; m (ServerStAcquiring block point query m ())
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#recvMsgReAcquire"><span class="hs-identifier hs-var">recvMsgReAcquire</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">point -&gt; m (ServerStAcquiring block point query m ())
</span><a href="#local-6989586621679213962"><span class="hs-identifier hs-var">goAcquiring</span></a></span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgRelease :: m (ServerStIdle block point query m ())
</span><a href="Ouroboros.Network.Protocol.LocalStateQuery.Server.html#recvMsgRelease"><span class="hs-identifier hs-var">recvMsgRelease</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStIdle block point query m ()
-&gt; m (ServerStIdle block point query m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ServerStIdle block point query m ()
</span><a href="#local-6989586621679213965"><span class="hs-identifier hs-var">goIdle</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span></pre></body></html>