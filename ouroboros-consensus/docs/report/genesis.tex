\documentclass[t]{beamer}
\usetheme{Rochester}

\usepackage{tikz}
\usepackage[utf8]{inputenc}

%Information to be included in the title page:
\title{Implementing the Genesis Chain Selection Rule}
\author{Edsko de Vries}
\institute{Well-Typed}
\date{November 2020}

\begin{document}

\frame{\titlepage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
\frametitle{The Genesis Rule}

\begin{alertblock}{Genesis chain selection rule}
A candidate chain is preferred over our current chain if

\begin{itemize}
\item The intersection between the candidate chain and our chain is no more
than $k$ blocks back, and the candidate chain is strictly longer than our
chain.

\item If the intersection \emph{is} more than $k$ blocks back, and the
candidate chain is \emph{denser} (contains more blocks) than our chain in
a region of $s$ slots starting at the intersection.
\end{itemize}
\end{alertblock}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
\frametitle{Fundamental Assumptions within the Consensus Layer}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{onlyenv}<1>

\begin{alertblock}{Invariant}
We never roll back more than $k$ blocks.
\end{alertblock}

This invariant is used to

\begin{itemize}
\item \textbf{Organize on-disk and in-memory block and ledger storage}: blocks older
than $k$ are stored in the \emph{immutable} database, the remainder in the
\emph{volatile} database.
\item \textbf{Guarantee efficient block validation}: we have access to the $k$
most recent ledger states
\item \textbf{Bound memory usage for tracking peers}: we need to track at most $k + 1$
blocks per upstream peer to be able to decide if we prefer their chain over
ours (apply the longest chain rule)
\item \dots
\end{itemize}

\end{onlyenv}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{onlyenv}<2>
\begin{alertblock}{Invariant}
We never switch to a shorter chain.
\end{alertblock}

\pause

Without this invariant, the previous invariant (never roll back
more than $k$ blocks) is not very useful.

\begin{itemize}
\item If we \emph{could} switch to a shorter chain but continue to support a
rollback of $k$, the \emph{effective} maximum rollback is infinite.
\item We would need efficient access to \emph{all} past ledger states.
\item We would have to move blocks \emph{back} from the immutable database to the volatile database.
\item \dots
\end{itemize}
\end{onlyenv}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{onlyenv}<3>

\begin{alertblock}{Invariant}
The strict extension of a chain is always preferred over that chain.
\end{alertblock}

\begin{itemize}
\item Used to make some local chain selection decisions.
\item (I \emph{think} this one is compatible with Genesis.)
\end{itemize}

\end{onlyenv}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
\frametitle{Towards an Alternative}

\begin{onlyenv}<1>

\begin{alertblock}{Key Idea: Delay the decision}
Rather than adopting chain $A$ as soon as we see it,
and later switch to chain $B$ (possibly incurring a large rollback), \emph{wait}:
don't adopt \emph{either} $A$ \emph{or} $B$ until we know which one we want.
\end{alertblock}

Assumptions:

\begin{itemize}
\item We can guarantee that we see (a representative sample of) all chains
in the network. An attacker \textbf{can't eclipse} us.
\item We can \textbf{detect when} the genesis rule applies. \\
(We will come back to this point later.)
\end{itemize}

\end{onlyenv}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}

\frametitle<1-3>{Choosing between forks: at genesis}
\frametitle<4-5>{Choosing between forks: general case}

\begin{center}
\begin{tikzpicture}
\path (0, 0) coordinate (tip) node{$\bullet$} node[left]{tip};
\draw (tip) -- ++(1.0,  1.0) coordinate (ab) node{$\bullet$} node[above left]{$ab$};
\draw [dotted] (tip) -- ++(1.5, -0.5) coordinate (cd);
\draw (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) node[right]{$A$};
\draw (ab) -- ++(0.5, -0.5) -- ++(2.0, 0) node[right]{$B$};
\draw [dotted] (cd) -- ++(0.5,  0.5) -- ++(1.5, 0) node[right]{$C$};
\draw [dotted] (cd) -- ++(0.5, -0.5) -- ++(1.5, 0) node[right]{$D$};
\draw [dashed]
     (tip)
  -- ++(0, 2)
  -- ++(3, 0)
  -- ++(0, -3.5)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\onslide<1-2>{\draw (tip) -- ++(1.5, -0.5) node{$\bullet$};}
\onslide<1-2>{\draw (cd) -- ++(0.5,  0.5) -- ++(1.5, 0);}
\onslide<1-2>{\draw (cd) node[below left]{$cd$} -- ++(0.5, -0.5) -- ++(1.5, 0);}
\onslide<2-5>{\draw [red, very thick] (tip) -- (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) ;}
\onslide<4-5>{\draw (tip) + (-3,0) node{$\bullet$} -- (tip);}
\end{tikzpicture}
\end{center}

\vspace{-1em}

\onslide<5>{
\begin{alertblock}{Committing}
By assumption, we have seen all relevant chains. We will \emph{never} be
interested in $C$ or $D$, so we can disconnect from them and never reconsider
them.
\end{alertblock}
}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}

\frametitle<1-3>{Common prefix: at genesis}
\frametitle<4-5>{Common prefix: general case}

\begin{center}
\begin{tikzpicture}
\path (0, 0) coordinate (tip) node{$\bullet$};
\draw (tip) -- ++(1.0,  0.0) coordinate (branch) node{$\bullet$};
\draw (branch) -- ++(1.0,  0.9) -- ++ (1.5, 0) node[right]{A};
\draw (branch) -- ++(1.0,  0.3) -- ++ (1.5, 0) node[right]{B};
\draw (branch) -- ++(1.0, -0.3) -- ++ (1.5, 0) node[right]{C};
\draw (branch) -- ++(1.0, -0.9) -- ++ (1.5, 0) node[right]{D};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\onslide<1-2>{\node [left] at (tip) {tip};}
\onslide<2>{\draw [red, very thick] (tip) -- ++(1.0,  0.0);}
\onslide<3-5>{\node [above left] at (branch) {tip};}
\onslide<1-2>{\draw [dashed]
     (tip)
  -- ++(0, 1.5)
  -- ++(3, 0)
  -- ++(0, -3)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;}
\onslide<3-5>{\draw [dashed]
     (branch)
  -- ++(0, 1.5)
  -- ++(2, 0)
  -- ++(0, -3)
  -- ++(-2, 0)  node[pos=0.25, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;}
\onslide<4-5>{\draw (tip) + (-3,0) node{$\bullet$} -- (tip);}

\end{tikzpicture}
\end{center}

\onslide<5>{
\begin{alertblock}{Committing}
By assumption, we have seen all relevant chains. They all share a common prefix.
We can \emph{commit to} the blocks on that common prefix: they will never
be rolled back.
\end{alertblock}
}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}

\frametitle{Insufficient peers}

\begin{center}
\begin{tikzpicture}[yscale=0.75]
\path (0, 0) -- (5,0); % adjust bounding box
\path (0, 0) coordinate (tip) node{$\bullet$} node[left]{tip};
\draw (tip) -- ++(1.0,  1.0) coordinate (ab) node{$\bullet$} node[above left]{$ab$};
\draw (tip) -- ++(1.5, -0.5) coordinate (cd);
\draw (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) node[right]{$A$};
\draw (ab) -- ++(0.5, -0.5) -- ++(2.0, 0) node[right]{$B$};
\draw (cd) -- ++(0.5,  0.5) -- ++(1.5, 0) node[right]{$C$};
\path (cd) -- ++(0.5, -0.5) -- ++(1.5, 0) coordinate (D);

\draw [dashed]
     (tip)
  -- ++(0, 2)
  -- ++(3, 0)
  -- ++(0, -3.5)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;
\draw [dotted] (D) -- ++(-2.5,0) -- ++(-0.25,0.25);

\draw [red, very thick] (tip) -- (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) ;
\draw (tip) + (-3,0) node{$\bullet$} -- (tip);
\end{tikzpicture}
\end{center}

\begin{center}
\begin{tikzpicture}[yscale=0.75]
\path (0, 0) -- (5,0); % adjust bounding box
\path (0, 0) coordinate (tip) node{$\bullet$};
\draw (tip) -- ++(1.0,  0.0) coordinate (branch) node{$\bullet$};
\draw (branch) -- ++(1.0,  0.9) -- ++ (1.5, 0) node[right]{A};
\draw (branch) -- ++(1.0,  0.3) -- ++ (1.5, 0) node[right]{B};
\draw (branch) -- ++(1.0, -0.3) -- ++ (1.5, 0) node[right]{C};
\path (branch) -- ++(1.0, -0.9) -- ++ (1.5, 0) coordinate(D);

\draw [dotted] (D) -- ++(-2.5,0) -- ++(-0.25,0.25);
\node [left] at (tip) {tip};
\draw [red, very thick] (tip) -- ++(1.0,  0.0);
\node [above left] at (branch) {tip};
\draw [dashed]
     (tip)
  -- ++(0, 1.5)
  -- ++(3, 0)
  -- ++(0, -3)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;
\draw (tip) + (-3,0) node{$\bullet$} -- (tip);

\end{tikzpicture}
\end{center}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}

\frametitle{Insufficient blocks}

\begin{center}
\begin{tikzpicture}[yscale=0.75]
\path (0, 0) -- (5,0); % adjust bounding box
\path (0, 0) coordinate (tip) node{$\bullet$} node[left]{tip};
\draw (tip) -- ++(1.0,  1.0) coordinate (ab) node{$\bullet$} node[above left]{$ab$};
\draw (tip) -- ++(1.5, -0.5) coordinate (cd);
\draw (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) node[right]{$A$};
\draw (ab) -- ++(0.5, -0.5) -- ++(2.0, 0) node[right]{$B$};
\draw (cd) -- ++(0.5,  0.5) -- ++(1.5, 0) node[right]{$C$};
\draw (cd) -- ++(0.5, -0.5) node{$\bullet$} node[right]{$D$};

\draw [dashed]
     (tip)
  -- ++(0, 2)
  -- ++(3, 0)
  -- ++(0, -3.5)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;

\draw [red, very thick] (tip) -- (ab) -- ++(0.5,  0.5) -- ++(2.0, 0) ;
\draw (tip) + (-3,0) node{$\bullet$} -- (tip);
\end{tikzpicture}
\end{center}

\begin{center}
\begin{tikzpicture}[yscale=0.75]
\path (0, 0) -- (5,0); % adjust bounding box
\path (0, 0) coordinate (tip) node{$\bullet$};
\draw (tip) -- ++(1.0,  0.0) coordinate (branch) node{$\bullet$};
\draw (branch) -- ++(1.0,  0.9) -- ++ (1.5, 0) node[right]{A};
\draw (branch) -- ++(1.0,  0.3) -- ++ (1.5, 0) node[right]{B};
\draw (branch) -- ++(1.0, -0.3) -- ++ (1.5, 0) node[right]{C};
\draw (branch) -- ++(1.0, -0.9) node{$\bullet$} node[right]{D};

\node [left] at (tip) {tip};
\draw [red, very thick] (tip) -- ++(1.0,  0.0);
\node [above left] at (branch) {tip};
\draw [dashed]
     (tip)
  -- ++(0, 1.5)
  -- ++(3, 0)
  -- ++(0, -3)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;
\draw (tip) + (-3,0) node{$\bullet$} -- (tip);

\end{tikzpicture}
\end{center}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}

\frametitle{Threshold for sufficient blocks}

\begin{center}
\begin{tikzpicture}[yscale=0.75]
\draw (0,0) -- (2,0) node{$\bullet$} coordinate (tip);
\draw [dotted] (tip) -- ++(1,1) -- ++ (0.5,0) node[right]{$\ldots$};
\draw [dotted] (tip) -- ++(1,0.5) -- ++ (0.5,0) node[right]{$\ldots$};
\draw (tip) -- ++(1,-0.25) node {$\bullet$} coordinate (a);
\onslide<2-6>{\draw (a) -- ++(0.5,  0) node {$\bullet$} coordinate (b);}
\onslide<3-6>{\draw (b) -- ++(1.0,  0) node {$\bullet$} coordinate (c);}
\onslide<4-6>{\draw (c) -- ++(0.25, 0) node {$\bullet$} coordinate (d);}
\onslide<5-6>{\draw (d) -- ++(1,    0) node {$\bullet$} coordinate (e);}
\draw [dashed]
     (tip)
  -- ++(0, 1.5)
  -- ++(3, 0)
  -- ++(0, -2.25)
  -- ++(-3, 0) node[pos=0.5, below]{$\underbrace{\hspace{3cm}}_s$}
  -- cycle;
\end{tikzpicture}
\end{center}

\onslide<6>{
\begin{alertblock}{Dealing with nodes that don't provide sufficient blocks}
As part of the protocol, nodes report their tip. Was optimization, now becomes essential:

\begin{itemize}
\item Disconnect from nodes that report a chain shorter than $s$.
\item Timeout from nodes that report a chain longer than $s$ but don't send
us blocks (DoS attack).
\end{itemize}
\end{alertblock}
}

\end{frame}



% TODO
% If s > k, what about the no-man's-land between s and k?
% does number of required peers shrink?

\end{document}
