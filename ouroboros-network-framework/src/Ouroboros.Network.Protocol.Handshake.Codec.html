<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds           #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Codec</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#codecHandshake"><span class="hs-identifier">codecHandshake</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#byteLimitsHandshake"><span class="hs-identifier">byteLimitsHandshake</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#timeLimitsHandshake"><span class="hs-identifier">timeLimitsHandshake</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#noTimeLimitsHandshake"><span class="hs-identifier">noTimeLimitsHandshake</span></a></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier">encodeRefuseReason</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeRefuseReason"><span class="hs-identifier">decodeRefuseReason</span></a></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Version data codec</span></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#VersionDataCodec"><span class="hs-identifier">VersionDataCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#cborTermVersionDataCodec"><span class="hs-identifier">cborTermVersionDataCodec</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadST</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">replicateM</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partitionEithers</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Decoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Read</span></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Term</span></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Codec.html"><span class="hs-identifier">Ouroboros.Network.Codec</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.CodecCBORTerm.html"><span class="hs-identifier">Ouroboros.Network.CodecCBORTerm</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Driver.Limits.html"><span class="hs-identifier">Ouroboros.Network.Driver.Limits</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.Limits.html"><span class="hs-identifier">Ouroboros.Network.Protocol.Limits</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Type</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- | Codec for version data ('vData' in code) exchanged by the handshake</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- protocol.</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- Note: 'extra' type param is instantiated to 'DictVersion'; 'agreedOptions'</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- is instatiated to 'NodeToNodeVersionData' in &quot;Ouroboros.Network.NodeToNode&quot;</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- or to '()' in &quot;Ouroboros.Network.NodeToClient&quot;.</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-keyword">data</span><span> </span><span id="VersionDataCodec"><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#VersionDataCodec"><span class="hs-identifier hs-var">VersionDataCodec</span></a></span></span><span> </span><span id="local-6989586621679130119"><span class="annot"><a href="#local-6989586621679130119"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679130121"><span class="annot"><a href="#local-6989586621679130121"><span class="hs-identifier hs-type">vNumber</span></a></span></span><span> </span><span id="local-6989586621679130120"><span class="annot"><a href="#local-6989586621679130120"><span class="hs-identifier hs-type">vData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VersionDataCodec"><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#VersionDataCodec"><span class="hs-identifier hs-var">VersionDataCodec</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-56"></span><span>    </span><span id="encodeData"><span class="annot"><span class="annottext">VersionDataCodec bytes vNumber vData -&gt; vNumber -&gt; vData -&gt; bytes
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeData"><span class="hs-identifier hs-var hs-var">encodeData</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679130121"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679130120"><span class="hs-identifier hs-type">vData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679130119"><span class="hs-identifier hs-type">bytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- ^ encoder of 'vData' which has access to 'extra vData' which can bring</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">-- extra instances into the scope (by means of pattern matching on a GADT).</span><span>
</span><span id="line-59"></span><span>    </span><span id="decodeData"><span class="annot"><span class="annottext">VersionDataCodec bytes vNumber vData
-&gt; vNumber -&gt; bytes -&gt; Either Text vData
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeData"><span class="hs-identifier hs-var hs-var">decodeData</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679130121"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679130119"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679130120"><span class="hs-identifier hs-type">vData</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- ^ decoder of 'vData'.</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- TODO: remove this from top level API, this is the only way we encode or</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- decode version data.</span><span>
</span><span id="line-65"></span><span id="local-6989586621679129967"><span id="local-6989586621679129968"><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#cborTermVersionDataCodec"><span class="hs-identifier hs-type">cborTermVersionDataCodec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679129968"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.CodecCBORTerm.html#CodecCBORTerm"><span class="hs-identifier hs-type">CodecCBORTerm</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679129967"><span class="hs-identifier hs-type">vData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#VersionDataCodec"><span class="hs-identifier hs-type">VersionDataCodec</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679129968"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129967"><span class="hs-identifier hs-type">vData</span></a></span></span></span><span>
</span><span id="line-67"></span><span id="cborTermVersionDataCodec"><span class="annot"><span class="annottext">cborTermVersionDataCodec :: (vNumber -&gt; CodecCBORTerm Text vData)
-&gt; VersionDataCodec Term vNumber vData
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#cborTermVersionDataCodec"><span class="hs-identifier hs-var hs-var">cborTermVersionDataCodec</span></a></span></span><span> </span><span id="local-6989586621679129966"><span class="annot"><span class="annottext">vNumber -&gt; CodecCBORTerm Text vData
</span><a href="#local-6989586621679129966"><span class="hs-identifier hs-var">codec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionDataCodec :: forall bytes vNumber vData.
(vNumber -&gt; vData -&gt; bytes)
-&gt; (vNumber -&gt; bytes -&gt; Either Text vData)
-&gt; VersionDataCodec bytes vNumber vData
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#VersionDataCodec"><span class="hs-identifier hs-type">VersionDataCodec</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-68"></span><span>      </span><span class="annot"><span class="annottext">encodeData :: vNumber -&gt; vData -&gt; Term
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeData"><span class="hs-identifier hs-var">encodeData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm Text vData -&gt; vData -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">(CodecCBORTerm Text vData -&gt; vData -&gt; Term)
-&gt; (vNumber -&gt; CodecCBORTerm Text vData)
-&gt; vNumber
-&gt; vData
-&gt; Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">vNumber -&gt; CodecCBORTerm Text vData
</span><a href="#local-6989586621679129966"><span class="hs-identifier hs-var">codec</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>      </span><span class="annot"><span class="annottext">decodeData :: vNumber -&gt; Term -&gt; Either Text vData
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeData"><span class="hs-identifier hs-var">decodeData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm Text vData -&gt; Term -&gt; Either Text vData
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">(CodecCBORTerm Text vData -&gt; Term -&gt; Either Text vData)
-&gt; (vNumber -&gt; CodecCBORTerm Text vData)
-&gt; vNumber
-&gt; Term
-&gt; Either Text vData
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">vNumber -&gt; CodecCBORTerm Text vData
</span><a href="#local-6989586621679129966"><span class="hs-identifier hs-var">codec</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- We assume that a TCP segment size of 1440 bytes with initial window of size</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- 4.  This sets upper limit of 5760 bytes on each message of handshake</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- protocol.</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#maxTransmissionUnit"><span class="hs-identifier hs-type">maxTransmissionUnit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-78"></span><span id="maxTransmissionUnit"><span class="annot"><span class="annottext">maxTransmissionUnit :: Word
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#maxTransmissionUnit"><span class="hs-identifier hs-var hs-var">maxTransmissionUnit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1440</span></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | Byte limits</span><span>
</span><span id="line-81"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#byteLimitsHandshake"><span class="hs-identifier hs-type">byteLimitsHandshake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679129960"><span class="annot"><a href="#local-6989586621679129960"><span class="hs-identifier hs-type">vNumber</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Network.Driver.Limits.html#ProtocolSizeLimits"><span class="hs-identifier hs-type">ProtocolSizeLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129960"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-82"></span><span id="byteLimitsHandshake"><span class="annot"><span class="annottext">byteLimitsHandshake :: ProtocolSizeLimits (Handshake vNumber Term) ByteString
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#byteLimitsHandshake"><span class="hs-identifier hs-var hs-var">byteLimitsHandshake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (pr :: PeerRole) (st :: Handshake vNumber Term).
 PeerHasAgency pr st -&gt; Word)
-&gt; (ByteString -&gt; Word)
-&gt; ProtocolSizeLimits (Handshake vNumber Term) ByteString
forall ps bytes.
(forall (pr :: PeerRole) (st :: ps). PeerHasAgency pr st -&gt; Word)
-&gt; (bytes -&gt; Word) -&gt; ProtocolSizeLimits ps bytes
</span><a href="Ouroboros.Network.Driver.Limits.html#ProtocolSizeLimits"><span class="hs-identifier hs-var">ProtocolSizeLimits</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pr :: PeerRole) (st :: Handshake vNumber Term).
PeerHasAgency pr st -&gt; Word
</span><a href="#local-6989586621679129958"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Word) -&gt; (ByteString -&gt; Int64) -&gt; ByteString -&gt; Word
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int64
</span><span class="hs-identifier hs-var">BL.length</span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="#local-6989586621679129958"><span class="hs-identifier hs-type">stateToLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129956"><span class="annot"><a href="#local-6989586621679129956"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerRole</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129955"><span class="annot"><a href="#local-6989586621679129955"><span class="hs-identifier hs-type">st</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129960"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-85"></span><span>                    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerHasAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129956"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129955"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621679129958"><span class="annot"><span class="annottext">stateToLimit :: PeerHasAgency pr st -&gt; Word
</span><a href="#local-6989586621679129958"><span class="hs-identifier hs-var hs-var">stateToLimit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#maxTransmissionUnit"><span class="hs-identifier hs-var">maxTransmissionUnit</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="#local-6989586621679129958"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#maxTransmissionUnit"><span class="hs-identifier hs-var">maxTransmissionUnit</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Time limits.</span><span>
</span><span id="line-90"></span><span class="hs-comment">--</span><span>
</span><span id="line-91"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#timeLimitsHandshake"><span class="hs-identifier hs-type">timeLimitsHandshake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679129950"><span class="annot"><a href="#local-6989586621679129950"><span class="hs-identifier hs-type">vNumber</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Network.Driver.Limits.html#ProtocolTimeLimits"><span class="hs-identifier hs-type">ProtocolTimeLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129950"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span id="timeLimitsHandshake"><span class="annot"><span class="annottext">timeLimitsHandshake :: ProtocolTimeLimits (Handshake vNumber Term)
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#timeLimitsHandshake"><span class="hs-identifier hs-var hs-var">timeLimitsHandshake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (pr :: PeerRole) (st :: Handshake vNumber Term).
 PeerHasAgency pr st -&gt; Maybe DiffTime)
-&gt; ProtocolTimeLimits (Handshake vNumber Term)
forall ps.
(forall (pr :: PeerRole) (st :: ps).
 PeerHasAgency pr st -&gt; Maybe DiffTime)
-&gt; ProtocolTimeLimits ps
</span><a href="Ouroboros.Network.Driver.Limits.html#ProtocolTimeLimits"><span class="hs-identifier hs-var">ProtocolTimeLimits</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pr :: PeerRole) (st :: Handshake vNumber Term).
PeerHasAgency pr st -&gt; Maybe DiffTime
</span><a href="#local-6989586621679129948"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><a href="#local-6989586621679129948"><span class="hs-identifier hs-type">stateToLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129947"><span class="annot"><a href="#local-6989586621679129947"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerRole</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129946"><span class="annot"><a href="#local-6989586621679129946"><span class="hs-identifier hs-type">st</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129950"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-95"></span><span>                    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerHasAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129947"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129946"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span>
</span><span id="line-96"></span><span>    </span><span id="local-6989586621679129948"><span class="annot"><span class="annottext">stateToLimit :: PeerHasAgency pr st -&gt; Maybe DiffTime
</span><a href="#local-6989586621679129948"><span class="hs-identifier hs-var hs-var">stateToLimit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="Ouroboros.Network.Protocol.Limits.html#shortWait"><span class="hs-identifier hs-var">shortWait</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="#local-6989586621679129948"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="Ouroboros.Network.Protocol.Limits.html#shortWait"><span class="hs-identifier hs-var">shortWait</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#noTimeLimitsHandshake"><span class="hs-identifier hs-type">noTimeLimitsHandshake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679129944"><span class="annot"><a href="#local-6989586621679129944"><span class="hs-identifier hs-type">vNumber</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Network.Driver.Limits.html#ProtocolTimeLimits"><span class="hs-identifier hs-type">ProtocolTimeLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129944"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span id="noTimeLimitsHandshake"><span class="annot"><span class="annottext">noTimeLimitsHandshake :: ProtocolTimeLimits (Handshake vNumber Term)
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#noTimeLimitsHandshake"><span class="hs-identifier hs-var hs-var">noTimeLimitsHandshake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (pr :: PeerRole) (st :: Handshake vNumber Term).
 PeerHasAgency pr st -&gt; Maybe DiffTime)
-&gt; ProtocolTimeLimits (Handshake vNumber Term)
forall ps.
(forall (pr :: PeerRole) (st :: ps).
 PeerHasAgency pr st -&gt; Maybe DiffTime)
-&gt; ProtocolTimeLimits ps
</span><a href="Ouroboros.Network.Driver.Limits.html#ProtocolTimeLimits"><span class="hs-identifier hs-var">ProtocolTimeLimits</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pr :: PeerRole) (st :: Handshake vNumber Term).
PeerHasAgency pr st -&gt; Maybe DiffTime
</span><a href="#local-6989586621679129943"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="#local-6989586621679129943"><span class="hs-identifier hs-type">stateToLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129942"><span class="annot"><a href="#local-6989586621679129942"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerRole</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129941"><span class="annot"><a href="#local-6989586621679129941"><span class="hs-identifier hs-type">st</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129944"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-104"></span><span>                    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerHasAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129942"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129941"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DiffTime</span></span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621679129943"><span class="annot"><span class="annottext">stateToLimit :: PeerHasAgency pr st -&gt; Maybe DiffTime
</span><a href="#local-6989586621679129943"><span class="hs-identifier hs-var hs-var">stateToLimit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="#local-6989586621679129943"><span class="hs-identifier hs-var">stateToLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- @'Handshake'@ codec.  The @'MsgProposeVersions'@ encodes proposed map in</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- ascending order and it expects to receive them in this order.  This allows</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- to construct the map in linear time.  There is also another limiting factor</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- to the number of versions on can present: the whole message must fit into</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- a single TCP segment.</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#codecHandshake"><span class="hs-identifier hs-type">codecHandshake</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679129940"><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span></span><span> </span><span id="local-6989586621679129939"><span class="annot"><a href="#local-6989586621679129939"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679129938"><span class="annot"><a href="#local-6989586621679129938"><span class="hs-identifier hs-type">failure</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-118"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129939"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-119"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-120"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679129938"><span class="hs-identifier hs-type">failure</span></a></span><span>
</span><span id="line-121"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.CodecCBORTerm.html#CodecCBORTerm"><span class="hs-identifier hs-type">CodecCBORTerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679129938"><span class="hs-identifier hs-type">failure</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">Codec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.DeserialiseFailure</span></span><span> </span><span class="annot"><a href="#local-6989586621679129939"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-124"></span><span id="codecHandshake"><span class="annot"><span class="annottext">codecHandshake :: CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Codec (Handshake vNumber Term) DeserialiseFailure m ByteString
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#codecHandshake"><span class="hs-identifier hs-var hs-var">codecHandshake</span></a></span></span><span> </span><span id="local-6989586621679129937"><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (pr :: PeerRole) (st :: Handshake vNumber Term)
        (st' :: Handshake vNumber Term).
 PeerHasAgency pr st
 -&gt; Message (Handshake vNumber Term) st st' -&gt; Encoding)
-&gt; (forall (pr :: PeerRole) (st :: Handshake vNumber Term) s.
    PeerHasAgency pr st -&gt; Decoder s (SomeMessage st))
-&gt; Codec (Handshake vNumber Term) DeserialiseFailure m ByteString
forall ps (m :: * -&gt; *).
MonadST m =&gt;
(forall (pr :: PeerRole) (st :: ps) (st' :: ps).
 PeerHasAgency pr st -&gt; Message ps st st' -&gt; Encoding)
-&gt; (forall (pr :: PeerRole) (st :: ps) s.
    PeerHasAgency pr st -&gt; Decoder s (SomeMessage st))
-&gt; Codec ps DeserialiseFailure m ByteString
</span><a href="Ouroboros.Network.Codec.html#mkCodecCborLazyBS"><span class="hs-identifier hs-var">mkCodecCborLazyBS</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pr :: PeerRole) (st :: Handshake vNumber Term)
       (st' :: Handshake vNumber Term).
PeerHasAgency pr st
-&gt; Message (Handshake vNumber Term) st st' -&gt; Encoding
</span><a href="#local-6989586621679129935"><span class="hs-identifier hs-var">encodeMsg</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pr :: PeerRole) s (st :: Handshake vNumber Term).
PeerHasAgency pr st -&gt; Decoder s (SomeMessage st)
forall (pr :: PeerRole) (st :: Handshake vNumber Term) s.
PeerHasAgency pr st -&gt; Decoder s (SomeMessage st)
</span><a href="#local-6989586621679129934"><span class="hs-identifier hs-var">decodeMsg</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><a href="#local-6989586621679129935"><span class="hs-identifier hs-type">encodeMsg</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129933"><span class="annot"><a href="#local-6989586621679129933"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerRole</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679129932"><span class="annot"><a href="#local-6989586621679129932"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679129931"><span class="annot"><a href="#local-6989586621679129931"><span class="hs-identifier hs-type">st'</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-128"></span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerHasAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129933"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129932"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679129932"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129931"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Encoding</span></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>      </span><span id="local-6989586621679129935"><span class="annot"><span class="annottext">encodeMsg :: PeerHasAgency pr st
-&gt; Message (Handshake vNumber Term) st st' -&gt; Encoding
</span><a href="#local-6989586621679129935"><span class="hs-identifier hs-var hs-var">encodeMsg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgProposeVersions"><span class="hs-identifier hs-type">MsgProposeVersions</span></a></span><span> </span><span id="local-6989586621679129929"><span class="annot"><a href="#local-6989586621679129929"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679129928"><span class="annot"><span class="annottext">vs' :: [(vNumber, vParams)]
</span><a href="#local-6989586621679129928"><span class="hs-identifier hs-var hs-var">vs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map vNumber vParams -&gt; [(vNumber, vParams)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toAscList</span></span><span> </span><span class="annot"><span class="annottext">Map vNumber vParams
</span><a href="#local-6989586621679129929"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-135"></span><span>           </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeMapLen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word) -&gt; Int -&gt; Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, vParams)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, vParams)]
</span><a href="#local-6989586621679129928"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Encoding] -&gt; Encoding
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span>    </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber -&gt; vNumber -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
vNumber
</span><a href="#local-6989586621679129921"><span class="hs-identifier hs-var">vNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>                     </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="annot"><span class="annottext">vParams
Term
</span><a href="#local-6989586621679129920"><span class="hs-identifier hs-var">vParams</span></a></span><span>
</span><span id="line-140"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679129921"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129921"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679129920"><span class="annot"><span class="annottext">vParams
</span><a href="#local-6989586621679129920"><span class="hs-identifier hs-var">vParams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(vNumber, vParams)]
</span><a href="#local-6989586621679129928"><span class="hs-identifier hs-var">vs'</span></a></span><span>
</span><span id="line-141"></span><span>                   </span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><a href="#local-6989586621679129935"><span class="hs-identifier hs-var">encodeMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgAcceptVersion"><span class="hs-identifier hs-type">MsgAcceptVersion</span></a></span><span> </span><span id="local-6989586621679129918"><span class="annot"><a href="#local-6989586621679129918"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span id="local-6989586621679129917"><span class="annot"><a href="#local-6989586621679129917"><span class="hs-identifier hs-var">vParams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>           </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">3</span></span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber -&gt; vNumber -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
vNumber
</span><a href="#local-6989586621679129918"><span class="hs-identifier hs-var">vNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="annot"><span class="annottext">vParams
Term
</span><a href="#local-6989586621679129917"><span class="hs-identifier hs-var">vParams</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><a href="#local-6989586621679129935"><span class="hs-identifier hs-var">encodeMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgRefuse"><span class="hs-identifier hs-type">MsgRefuse</span></a></span><span> </span><span id="local-6989586621679129915"><span class="annot"><a href="#local-6989586621679129915"><span class="hs-identifier hs-var">vReason</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-150"></span><span>           </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; RefuseReason vNumber -&gt; Encoding
forall fail vNumber.
CodecCBORTerm fail vNumber -&gt; RefuseReason vNumber -&gt; Encoding
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier hs-var">encodeRefuseReason</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">RefuseReason vNumber
RefuseReason vNumber
</span><a href="#local-6989586621679129915"><span class="hs-identifier hs-var">vReason</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-comment">-- decode a map checking the assumption that</span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-comment">--  * keys are different</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-comment">--  * keys are encoded in ascending order</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- fail when one of these assumptions is not met</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621679130032"><span class="annot"><a href="#local-6989586621679129914"><span class="hs-identifier hs-type">decodeMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-159"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-160"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-161"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679130032"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-162"></span><span>      </span><span id="local-6989586621679129914"><span class="annot"><span class="annottext">decodeMap :: Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
</span><a href="#local-6989586621679129914"><span class="hs-identifier hs-var hs-var">decodeMap</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>  </span><span class="annot"><span class="annottext">Maybe vNumber
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">!</span><span id="local-6989586621679129913"><span class="annot"><span class="annottext">[(vNumber, Term)]
</span><a href="#local-6989586621679129913"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map vNumber Term -&gt; Decoder s (Map vNumber Term)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map vNumber Term -&gt; Decoder s (Map vNumber Term))
-&gt; Map vNumber Term -&gt; Decoder s (Map vNumber Term)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, Term)] -&gt; Map vNumber Term
forall k a. [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromDistinctAscList</span></span><span> </span><span class="annot"><span class="annottext">([(vNumber, Term)] -&gt; Map vNumber Term)
-&gt; [(vNumber, Term)] -&gt; Map vNumber Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, Term)] -&gt; [(vNumber, Term)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, Term)]
</span><a href="#local-6989586621679129913"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><a href="#local-6989586621679129914"><span class="hs-identifier hs-var">decodeMap</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679129910"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129910"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679129909"><span class="annot"><span class="annottext">Maybe vNumber
</span><a href="#local-6989586621679129909"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679129908"><span class="annot"><span class="annottext">[(vNumber, Term)]
</span><a href="#local-6989586621679129908"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621679129907"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679129907"><span class="hs-identifier hs-var">vNumberTerm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-165"></span><span>        </span><span id="local-6989586621679129905"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679129905"><span class="hs-identifier hs-var">vParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Term -&gt; Either (failure, Maybe Int) vNumber
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679129907"><span class="hs-identifier hs-var">vNumberTerm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>          </span><span class="hs-comment">-- error when decoding un-recognized version; skip the version</span><span>
</span><span id="line-168"></span><span>          </span><span class="hs-comment">-- TODO: include error in the dictionary</span><span>
</span><span id="line-169"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
forall s.
Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
</span><a href="#local-6989586621679129914"><span class="hs-identifier hs-var">decodeMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">pred</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129910"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe vNumber
</span><a href="#local-6989586621679129909"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">[(vNumber, Term)]
</span><a href="#local-6989586621679129908"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679129903"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129903"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679129902"><span class="annot"><span class="annottext">next :: Maybe vNumber
</span><a href="#local-6989586621679129902"><span class="hs-identifier hs-var hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">vNumber -&gt; Maybe vNumber
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129903"><span class="hs-identifier hs-var">vNumber</span></a></span><span>
</span><span id="line-173"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Decoder s () -&gt; Decoder s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe vNumber
</span><a href="#local-6989586621679129902"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe vNumber -&gt; Maybe vNumber -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe vNumber
</span><a href="#local-6989586621679129909"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>              </span><span class="annot"><span class="annottext">(Decoder s () -&gt; Decoder s ()) -&gt; Decoder s () -&gt; Decoder s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;codecHandshake.Propose: unordered version&quot;</span></span><span>
</span><span id="line-175"></span><span>            </span><span class="annot"><span class="annottext">Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
forall s.
Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
</span><a href="#local-6989586621679129914"><span class="hs-identifier hs-var">decodeMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">pred</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129910"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe vNumber
</span><a href="#local-6989586621679129902"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129903"><span class="hs-identifier hs-var">vNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679129905"><span class="hs-identifier hs-var">vParams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(vNumber, Term) -&gt; [(vNumber, Term)] -&gt; [(vNumber, Term)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(vNumber, Term)]
</span><a href="#local-6989586621679129908"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><a href="#local-6989586621679129934"><span class="hs-identifier hs-type">decodeMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679130063"><span class="annot"><a href="#local-6989586621679130063"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerRole</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679130061"><span class="annot"><a href="#local-6989586621679130061"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679130062"><span class="annot"><a href="#local-6989586621679130062"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679129940"><span class="hs-identifier hs-type">vNumber</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Term</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-178"></span><span>                   </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">PeerHasAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130063"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130062"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-179"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679130061"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">SomeMessage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130062"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>      </span><span id="local-6989586621679129934"><span class="annot"><span class="annottext">decodeMsg :: PeerHasAgency pr st -&gt; Decoder s (SomeMessage st)
</span><a href="#local-6989586621679129934"><span class="hs-identifier hs-var hs-var">decodeMsg</span></a></span></span><span> </span><span id="local-6989586621679129900"><span class="annot"><span class="annottext">PeerHasAgency pr st
</span><a href="#local-6989586621679129900"><span class="hs-identifier hs-var">stok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Int
forall s. Decoder s Int
</span><span class="hs-identifier hs-var">CBOR.decodeListLen</span></span><span>
</span><span id="line-182"></span><span>        </span><span id="local-6989586621679129898"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679129898"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Word
forall s. Decoder s Word
</span><span class="hs-identifier hs-var">CBOR.decodeWord</span></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerHasAgency pr st
</span><a href="#local-6989586621679129900"><span class="hs-identifier hs-var">stok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679129898"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>            </span><span id="local-6989586621679129896"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129896"><span class="hs-identifier hs-var">l</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Int
forall s. Decoder s Int
</span><span class="hs-identifier hs-var">CBOR.decodeMapLen</span></span><span>
</span><span id="line-186"></span><span>            </span><span id="local-6989586621679129894"><span class="annot"><span class="annottext">Map vNumber Term
</span><a href="#local-6989586621679129894"><span class="hs-identifier hs-var">vMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
forall s.
Int
-&gt; Maybe vNumber
-&gt; [(vNumber, Term)]
-&gt; Decoder s (Map vNumber Term)
</span><a href="#local-6989586621679129914"><span class="hs-identifier hs-var">decodeMap</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129896"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe vNumber
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">SomeMessage 'StPropose -&gt; Decoder s (SomeMessage 'StPropose)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SomeMessage 'StPropose -&gt; Decoder s (SomeMessage 'StPropose))
-&gt; SomeMessage 'StPropose -&gt; Decoder s (SomeMessage 'StPropose)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Message (Handshake vNumber Term) 'StPropose 'StConfirm
-&gt; SomeMessage 'StPropose
forall ps (st :: ps) (st' :: ps).
Message ps st st' -&gt; SomeMessage st
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">SomeMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message (Handshake vNumber Term) 'StPropose 'StConfirm
 -&gt; SomeMessage 'StPropose)
-&gt; Message (Handshake vNumber Term) 'StPropose 'StConfirm
-&gt; SomeMessage 'StPropose
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map vNumber Term
-&gt; Message (Handshake vNumber Term) 'StPropose 'StConfirm
forall vNumber vNumber.
Map vNumber vNumber
-&gt; Message (Handshake vNumber vNumber) 'StPropose 'StConfirm
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgProposeVersions"><span class="hs-identifier hs-var">MsgProposeVersions</span></a></span><span> </span><span class="annot"><span class="annottext">Map vNumber Term
</span><a href="#local-6989586621679129894"><span class="hs-identifier hs-var">vMap</span></a></span><span>
</span><span id="line-188"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>            </span><span id="local-6989586621679129892"><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129892"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Term -&gt; Either (failure, Maybe Int) vNumber
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Either (failure, Maybe Int) vNumber)
-&gt; Decoder s Term
-&gt; Decoder s (Either (failure, Maybe Int) vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-190"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-191"></span><span>              </span><span class="hs-comment">-- at this stage we can throw exception when decoding</span><span>
</span><span id="line-192"></span><span>              </span><span class="hs-comment">-- version number: 'MsgAcceptVersion' must send us back</span><span>
</span><span id="line-193"></span><span>              </span><span class="hs-comment">-- version which we know how to decode</span><span>
</span><span id="line-194"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679129890"><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129890"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (SomeMessage st)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;codecHandshake.MsgAcceptVersion: not recognized version: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129890"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679129888"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129888"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>                </span><span class="annot"><span class="annottext">Message (Handshake vNumber Term) 'StConfirm 'StDone
-&gt; SomeMessage 'StConfirm
forall ps (st :: ps) (st' :: ps).
Message ps st st' -&gt; SomeMessage st
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">SomeMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message (Handshake vNumber Term) 'StConfirm 'StDone
 -&gt; SomeMessage 'StConfirm)
-&gt; (Term -&gt; Message (Handshake vNumber Term) 'StConfirm 'StDone)
-&gt; Term
-&gt; SomeMessage 'StConfirm
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">vNumber
-&gt; Term -&gt; Message (Handshake vNumber Term) 'StConfirm 'StDone
forall vNumber vNumber.
vNumber
-&gt; vNumber
-&gt; Message (Handshake vNumber vNumber) 'StConfirm 'StDone
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgAcceptVersion"><span class="hs-identifier hs-var">MsgAcceptVersion</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129888"><span class="hs-identifier hs-var">vNumber</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; SomeMessage 'StConfirm)
-&gt; Decoder s Term -&gt; Decoder s (SomeMessage 'StConfirm)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-197"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>            </span><span class="annot"><span class="annottext">Message (Handshake vNumber Term) 'StConfirm 'StDone
-&gt; SomeMessage 'StConfirm
forall ps (st :: ps) (st' :: ps).
Message ps st st' -&gt; SomeMessage st
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">SomeMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message (Handshake vNumber Term) 'StConfirm 'StDone
 -&gt; SomeMessage 'StConfirm)
-&gt; (RefuseReason vNumber
    -&gt; Message (Handshake vNumber Term) 'StConfirm 'StDone)
-&gt; RefuseReason vNumber
-&gt; SomeMessage 'StConfirm
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RefuseReason vNumber
-&gt; Message (Handshake vNumber Term) 'StConfirm 'StDone
forall k vNumber (vParams :: k).
RefuseReason vNumber
-&gt; Message (Handshake vNumber vParams) 'StConfirm 'StDone
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#MsgRefuse"><span class="hs-identifier hs-var">MsgRefuse</span></a></span><span> </span><span class="annot"><span class="annottext">(RefuseReason vNumber -&gt; SomeMessage 'StConfirm)
-&gt; Decoder s (RefuseReason vNumber)
-&gt; Decoder s (SomeMessage 'StConfirm)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Decoder s (RefuseReason vNumber)
forall failure vNumber s.
Show failure =&gt;
CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Decoder s (RefuseReason vNumber)
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeRefuseReason"><span class="hs-identifier hs-var">decodeRefuseReason</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129937"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ClientHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokPropose"><span class="hs-identifier hs-var">TokPropose</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (SomeMessage st)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;codecHandshake.Propose: unexpected key&quot;</span></span><span>
</span><span id="line-201"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHasAgency st
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#TokConfirm"><span class="hs-identifier hs-var">TokConfirm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (SomeMessage st)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;codecHandshake.Confirm: unexpected key&quot;</span></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span id="local-6989586621679130041"><span id="local-6989586621679130042"><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier hs-type">encodeRefuseReason</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.CodecCBORTerm.html#CodecCBORTerm"><span class="hs-identifier hs-type">CodecCBORTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130042"><span class="hs-identifier hs-type">fail</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130041"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-205"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#RefuseReason"><span class="hs-identifier hs-type">RefuseReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130041"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-206"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Encoding</span></span></span></span><span>
</span><span id="line-207"></span><span id="encodeRefuseReason"><span class="annot"><span class="annottext">encodeRefuseReason :: CodecCBORTerm fail vNumber -&gt; RefuseReason vNumber -&gt; Encoding
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier hs-var hs-var">encodeRefuseReason</span></a></span></span><span> </span><span id="local-6989586621679129887"><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129887"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#VersionMismatch"><span class="hs-identifier hs-type">VersionMismatch</span></a></span><span> </span><span id="local-6989586621679129885"><span class="annot"><span class="annottext">[vNumber]
</span><a href="#local-6989586621679129885"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-208"></span><span>         </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word) -&gt; Int -&gt; Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[vNumber] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[vNumber]
</span><a href="#local-6989586621679129885"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(vNumber -&gt; Encoding) -&gt; [vNumber] -&gt; Encoding
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Encoding) -&gt; (vNumber -&gt; Term) -&gt; vNumber -&gt; Encoding
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber -&gt; vNumber -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129887"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[vNumber]
</span><a href="#local-6989586621679129885"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-212"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier hs-var">encodeRefuseReason</span></a></span><span> </span><span id="local-6989586621679129883"><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129883"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#HandshakeDecodeError"><span class="hs-identifier hs-type">HandshakeDecodeError</span></a></span><span> </span><span id="local-6989586621679129881"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129881"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span id="local-6989586621679129880"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679129880"><span class="hs-identifier hs-var">vError</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-213"></span><span>         </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">3</span></span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-215"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber -&gt; vNumber -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129883"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129881"><span class="hs-identifier hs-var">vNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeString</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679129880"><span class="hs-identifier hs-var">vError</span></a></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#encodeRefuseReason"><span class="hs-identifier hs-var">encodeRefuseReason</span></a></span><span> </span><span id="local-6989586621679129878"><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129878"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Refused"><span class="hs-identifier hs-type">Refused</span></a></span><span> </span><span id="local-6989586621679129876"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129876"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span id="local-6989586621679129875"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679129875"><span class="hs-identifier hs-var">vReason</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>         </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeListLen</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">3</span></span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeWord</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeTerm</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber -&gt; vNumber -&gt; Term
forall fail a. CodecCBORTerm fail a -&gt; a -&gt; Term
</span><a href="Ouroboros.Network.CodecCBORTerm.html#encodeTerm"><span class="hs-identifier hs-var hs-var">encodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm fail vNumber
</span><a href="#local-6989586621679129878"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129876"><span class="hs-identifier hs-var">vNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Encoding
</span><span class="hs-identifier hs-var">CBOR.encodeString</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679129875"><span class="hs-identifier hs-var">vReason</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span id="local-6989586621679130000"><span id="local-6989586621679130001"><span id="local-6989586621679130002"><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeRefuseReason"><span class="hs-identifier hs-type">decodeRefuseReason</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679130002"><span class="hs-identifier hs-type">failure</span></a></span><span>
</span><span id="line-225"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.CodecCBORTerm.html#CodecCBORTerm"><span class="hs-identifier hs-type">CodecCBORTerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679130002"><span class="hs-identifier hs-type">failure</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679130001"><span class="hs-identifier hs-type">vNumber</span></a></span><span>
</span><span id="line-226"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679130000"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Type.html#RefuseReason"><span class="hs-identifier hs-type">RefuseReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130001"><span class="hs-identifier hs-type">vNumber</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-227"></span><span id="decodeRefuseReason"><span class="annot"><span class="annottext">decodeRefuseReason :: CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Decoder s (RefuseReason vNumber)
</span><a href="Ouroboros.Network.Protocol.Handshake.Codec.html#decodeRefuseReason"><span class="hs-identifier hs-var hs-var">decodeRefuseReason</span></a></span></span><span> </span><span id="local-6989586621679129874"><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129874"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Int
forall s. Decoder s Int
</span><span class="hs-identifier hs-var">CBOR.decodeListLen</span></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621679129873"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679129873"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Word
forall s. Decoder s Word
</span><span class="hs-identifier hs-var">CBOR.decodeWord</span></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679129873"><span class="hs-identifier hs-var">tag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>        </span><span id="local-6989586621679129872"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129872"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Int
forall s. Decoder s Int
</span><span class="hs-identifier hs-var">CBOR.decodeListLen</span></span><span>
</span><span id="line-233"></span><span>        </span><span id="local-6989586621679129871"><span class="annot"><span class="annottext">[Either (failure, Maybe Int) vNumber]
</span><a href="#local-6989586621679129871"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Decoder s (Either (failure, Maybe Int) vNumber)
-&gt; Decoder s [Either (failure, Maybe Int) vNumber]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679129872"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-234"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Term -&gt; Either (failure, Maybe Int) vNumber
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129874"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Either (failure, Maybe Int) vNumber)
-&gt; Decoder s Term
-&gt; Decoder s (Either (failure, Maybe Int) vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Either (failure, Maybe Int) vNumber]
-&gt; ([(failure, Maybe Int)], [vNumber])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">[Either (failure, Maybe Int) vNumber]
</span><a href="#local-6989586621679129871"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679129870"><span class="annot"><span class="annottext">[(failure, Maybe Int)]
</span><a href="#local-6989586621679129870"><span class="hs-identifier hs-var">errs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679129869"><span class="annot"><span class="annottext">[vNumber]
</span><a href="#local-6989586621679129869"><span class="hs-identifier hs-var">vNumbers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">RefuseReason vNumber -&gt; Decoder s (RefuseReason vNumber)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RefuseReason vNumber -&gt; Decoder s (RefuseReason vNumber))
-&gt; RefuseReason vNumber -&gt; Decoder s (RefuseReason vNumber)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[vNumber] -&gt; [Int] -&gt; RefuseReason vNumber
forall vNumber. [vNumber] -&gt; [Int] -&gt; RefuseReason vNumber
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#VersionMismatch"><span class="hs-identifier hs-var">VersionMismatch</span></a></span><span> </span><span class="annot"><span class="annottext">[vNumber]
</span><a href="#local-6989586621679129869"><span class="hs-identifier hs-var">vNumbers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((failure, Maybe Int) -&gt; Maybe Int)
-&gt; [(failure, Maybe Int)] -&gt; [Int]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int) -&gt; Maybe Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(failure, Maybe Int)]
</span><a href="#local-6989586621679129870"><span class="hs-identifier hs-var">errs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>      </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>        </span><span id="local-6989586621679129868"><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129868"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Term -&gt; Either (failure, Maybe Int) vNumber
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129874"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Either (failure, Maybe Int) vNumber)
-&gt; Decoder s Term
-&gt; Decoder s (Either (failure, Maybe Int) vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129868"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-241"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679129867"><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129867"><span class="hs-identifier hs-var">e</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (RefuseReason vNumber)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Decoder s (RefuseReason vNumber))
-&gt; String -&gt; Decoder s (RefuseReason vNumber)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;decode HandshakeDecodeError: unknow version: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129867"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-242"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679129866"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129866"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">vNumber -&gt; Text -&gt; RefuseReason vNumber
forall vNumber. vNumber -&gt; Text -&gt; RefuseReason vNumber
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#HandshakeDecodeError"><span class="hs-identifier hs-var">HandshakeDecodeError</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129866"><span class="hs-identifier hs-var">vNumber</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RefuseReason vNumber)
-&gt; Decoder s Text -&gt; Decoder s (RefuseReason vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Text
forall s. Decoder s Text
</span><span class="hs-identifier hs-var">CBOR.decodeString</span></span><span>
</span><span id="line-243"></span><span>      </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>        </span><span id="local-6989586621679129864"><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129864"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
-&gt; Term -&gt; Either (failure, Maybe Int) vNumber
forall fail a. CodecCBORTerm fail a -&gt; Term -&gt; Either fail a
</span><a href="Ouroboros.Network.CodecCBORTerm.html#decodeTerm"><span class="hs-identifier hs-var hs-var">decodeTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CodecCBORTerm (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129874"><span class="hs-identifier hs-var">versionNumberCodec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Either (failure, Maybe Int) vNumber)
-&gt; Decoder s Term
-&gt; Decoder s (Either (failure, Maybe Int) vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Term
forall s. Decoder s Term
</span><span class="hs-identifier hs-var">CBOR.decodeTerm</span></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (failure, Maybe Int) vNumber
</span><a href="#local-6989586621679129864"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679129863"><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129863"><span class="hs-identifier hs-var">e</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (RefuseReason vNumber)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Decoder s (RefuseReason vNumber))
-&gt; String -&gt; Decoder s (RefuseReason vNumber)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;decode Refused: unknonwn version: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(failure, Maybe Int)
</span><a href="#local-6989586621679129863"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679129862"><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129862"><span class="hs-identifier hs-var">vNumber</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">vNumber -&gt; Text -&gt; RefuseReason vNumber
forall vNumber. vNumber -&gt; Text -&gt; RefuseReason vNumber
</span><a href="Ouroboros.Network.Protocol.Handshake.Type.html#Refused"><span class="hs-identifier hs-var">Refused</span></a></span><span> </span><span class="annot"><span class="annottext">vNumber
</span><a href="#local-6989586621679129862"><span class="hs-identifier hs-var">vNumber</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RefuseReason vNumber)
-&gt; Decoder s Text -&gt; Decoder s (RefuseReason vNumber)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s Text
forall s. Decoder s Text
</span><span class="hs-identifier hs-var">CBOR.decodeString</span></span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Decoder s (RefuseReason vNumber)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Decoder s (RefuseReason vNumber))
-&gt; String -&gt; Decoder s (RefuseReason vNumber)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;decode RefuseReason: unknown tag &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679129873"><span class="hs-identifier hs-var">tag</span></a></span><span>
</span><span id="line-249"></span></pre></body></html>